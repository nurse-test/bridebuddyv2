<!DOCTYPE html>
<html>
<head>
    <title>Bride Buddy</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="margin:0;font-family:sans-serif;background:linear-gradient(135deg,#fce4ec,#f3e5f5);height:100vh;display:flex;flex-direction:column;">
    <div style="background:white;padding:20px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,0.1);position:relative;">
        <h1 style="background:linear-gradient(135deg,#ec407a,#ab47bc);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:0;">Bride Buddy üíç</h1>
        <button onclick="logout()" style="position:absolute;right:20px;top:20px;padding:8px 16px;background:white;border:2px solid #ec407a;color:#ec407a;border-radius:20px;cursor:pointer;">Logout</button>
        <button onclick="showInvite()" style="position:absolute;left:20px;top:20px;padding:8px 16px;background:white;border:2px solid #ec407a;color:#ec407a;border-radius:20px;cursor:pointer;">Invite Co-Planner</button>
    </div>
    <div id="chat" style="flex:1;overflow-y:auto;padding:20px;"></div>
    <div style="background:white;padding:16px;">
        <div style="display:flex;gap:8px;max-width:800px;margin:0 auto;">
            <input id="input" type="text" placeholder="Ask about weddings..." style="flex:1;padding:12px;border:2px solid #fce4ec;border-radius:24px;" onkeypress="if(event.key==='Enter')send()">
            <button onclick="send()" style="padding:12px 24px;background:linear-gradient(135deg,#ec407a,#ab47bc);color:white;border:none;border-radius:24px;cursor:pointer;">Send</button>
        </div>
    </div>
    <script>
const supabase=window.supabase.createClient('https://nluvnjydydotsrpluhey.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sdXZuanlkeWRvdHNycGx1aGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NjE5MjAsImV4cCI6MjA3NjMzNzkyMH0.p5S8vYtZeYqp24avigifhjEDRaKv8TxJTaTkeLoE5mY');
let user,convId;

supabase.auth.getSession().then(async({data:{session}})=>{
    if(!session)window.location.href='/auth.html';
    else{
        user=session.user;
        
        // Check VIP/trial status
        const {data:membership} = await supabase
            .from('wedding_members')
            .select('wedding_id')
            .eq('user_id', user.id)
            .single();
        
        if(membership){
            const {data:wedding} = await supabase
                .from('wedding_profiles')
                .select('trial_ends_at, is_vip, vip_expires_at, deleted_at')
                .eq('id', membership.wedding_id)
                .single();
            
            if(wedding){
                const now = new Date();
                const trialActive = wedding.trial_ends_at && new Date(wedding.trial_ends_at) > now;
                const vipActive = wedding.is_vip && (!wedding.vip_expires_at || new Date(wedding.vip_expires_at) > now);
                
                if(!trialActive && !vipActive){
                    window.location.href='/paywall.html';
                    return;
                }
            }
        }
    }
});

function logout(){supabase.auth.signOut();window.location.href='/auth.html';}

async function showInvite(){
    const session = await supabase.auth.getSession();
    const res = await fetch('/api/create-invite', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({userToken: session.data.session.access_token})
    });
    const data = await res.json();
    if(data.invite_code){
        const link = `${window.location.origin}/join.html?code=${data.invite_code}`;
        prompt('Share this ONE-TIME invite link:', link);
    } else {
        alert('Error: ' + (data.error || 'Failed to create invite'));
    }
}

async function send(){
    const inp=document.getElementById('input'),msg=inp.value.trim();
    if(!msg||!user)return;
    inp.value='';inp.disabled=true;
    add(msg,'user');
    const session=await supabase.auth.getSession();
    const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg,userToken:session.data.session.access_token,conversationId:convId})});
    const data=await res.json();
    if(data.response){add(data.response,'assistant');if(data.conversationId)convId=data.conversationId;}
    inp.disabled=false;inp.focus();
}

function add(txt,role){
    const d=document.createElement('div');
    d.style.cssText=role==='user'?'display:flex;justify-content:flex-end;margin-bottom:16px;':'display:flex;margin-bottom:16px;';
    d.innerHTML=`<div style="max-width:70%;padding:12px 16px;border-radius:18px;${role==='user'?'background:linear-gradient(135deg,#ec407a,#ab47bc);color:white;':'background:white;color:#333;box-shadow:0 1px 2px rgba(0,0,0,0.1);'}">${txt}</div>`;
    document.getElementById('chat').appendChild(d);
    document.getElementById('chat').scrollTop=999999;
}

add("Hi! I'm your Bride Buddy üíç Ask me anything about wedding planning!",'assistant');
    </script>
</body>
</html>
