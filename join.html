<!DOCTYPE html>
<html>
<head>
    <title>Join Wedding - Bride Buddy</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:sans-serif;background:linear-gradient(135deg,#fce4ec,#f3e5f5);height:100vh;display:flex;align-items:center;justify-content:center;}
        .box{background:white;padding:40px;border-radius:20px;width:100%;max-width:400px;text-align:center;}
        h1{background:linear-gradient(135deg,#ec407a,#ab47bc);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:20px;}
        p{color:#666;margin-bottom:20px;}
        input{width:100%;padding:12px;margin:10px 0;border:2px solid #fce4ec;border-radius:12px;}
        button{width:100%;padding:14px;background:linear-gradient(135deg,#ec407a,#ab47bc);color:white;border:none;border-radius:12px;margin-top:10px;cursor:pointer;}
        .msg{padding:10px;margin:10px 0;border-radius:8px;}
        .error{background:#ffebee;color:#c62828;}
        .success{background:#e8f5e9;color:#2e7d32;}
    </style>
</head>
<body>
    <div class="box">
        <h1>Bride Buddy üíç</h1>
        <p>You've been invited to help plan a wedding!</p>
        <div id="msg"></div>
        <div id="authSection">
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="Password (min 6 chars)" minlength="6">
            <button onclick="joinWedding()">Sign Up & Join</button>
            <p style="margin-top:20px;font-size:14px;">Already have an account? <a href="#" onclick="signIn();return false;" style="color:#ec407a;">Sign In</a></p>
        </div>
    </div>
    <script>
const supabase=window.supabase.createClient('https://nluvnjydydotsrpluhey.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sdXZuanlkeWRvdHNycGx1aGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NjE5MjAsImV4cCI6MjA3NjMzNzkyMH0.p5S8vYtZeYqp24avigifhjEDRaKv8TxJTaTkeLoE5mY');
const params=new URLSearchParams(window.location.search);
const inviteCode=params.get('code');

if(!inviteCode){
    document.getElementById('msg').innerHTML='<div class="msg error">Invalid invite link</div>';
    document.getElementById('authSection').style.display='none';
}

async function joinWedding(){
    const email=document.getElementById('email').value;
    const pass=document.getElementById('pass').value;
    if(!email||!pass){
        document.getElementById('msg').innerHTML='<div class="msg error">Please enter email and password</div>';
        return;
    }
    try{
        const {data,error}=await supabase.auth.signUp({email,password:pass});
        if(error)throw error;
        await addToWedding(data.session.access_token);
    }catch(e){
        document.getElementById('msg').innerHTML=`<div class="msg error">${e.message}</div>`;
    }
}

async function signIn(){
    const email=document.getElementById('email').value;
    const pass=document.getElementById('pass').value;
    if(!email||!pass){
        document.getElementById('msg').innerHTML='<div class="msg error">Please enter email and password</div>';
        return;
    }
    try{
        const {data,error}=await supabase.auth.signInWithPassword({email,password:pass});
        if(error)throw error;
        await addToWedding(data.session.access_token);
    }catch(e){
        document.getElementById('msg').innerHTML=`<div class="msg error">${e.message}</div>`;
    }
}
 async function addToWedding(token){
    const res=await fetch('https://nluvnjydydotsrpluhey.supabase.co/functions/v1/join-wedding',{
        method:'POST',
        headers:{
            'Content-Type':'application/json',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sdXZuanlkeWRvdHNycGx1aGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NjE5MjAsImV4cCI6MjA3NjMzNzkyMH0.p5S8vYtZeYqp24avigifhjEDRaKv8TxJTaTkeLoE5mY'
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sdXZuanlkeWRvdHNycGx1aGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NjE5MjAsImV4cCI6MjA3NjMzNzkyMH0.p5S8vYtZeYqp24avigifhjEDRaKv8TxJTaTkeLoE5mY'    
 },
        body:JSON.stringify({inviteCode,userToken:token})
    });
    const result=await res.json();
    if(res.ok){
        document.getElementById('msg').innerHTML='<div class="msg success">Successfully joined! Redirecting...</div>';
        setTimeout(()=>window.location.href='/',2000);
    }else{
        document.getElementById('msg').innerHTML=`<div class="msg error">${result.error}</div>`;
    }
}
    </script>
</body>
</html>
