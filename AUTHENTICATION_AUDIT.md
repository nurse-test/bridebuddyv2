# AUTHENTICATION SYSTEM AUDIT

**Audit Date:** 2025-10-24
**System:** Bride Buddy Wedding Planning SaaS
**Authentication Provider:** Supabase Auth

---

## EXECUTIVE SUMMARY

**Authentication Method:** Supabase Auth (email/password)
**Session Management:** Supabase JWT tokens (stored in localStorage by Supabase SDK)
**Overall Security:** ‚ö†Ô∏è **MIXED** - Some endpoints properly authenticated, others have vulnerabilities

### Key Findings:
- ‚úÖ Supabase Auth properly implemented for signup/login
- ‚úÖ Most newer endpoints properly verify user tokens
- ‚ö†Ô∏è **CRITICAL:** One endpoint (`create-wedding.js`) lacks authentication
- ‚úÖ Passwords hashed by Supabase (bcrypt)
- ‚úÖ RLS policies in place (need verification)
- ‚ö†Ô∏è No email verification enabled
- ‚ö†Ô∏è No password reset flow implemented
- ‚ö†Ô∏è No session timeout/auto-refresh visible

---

## 1. ACCOUNT CREATION

### Files Involved:
- **`public/welcome-v2.html`** - Landing page with "Start Your Wedding" button
- **`public/onboarding-v2.html`** - 7-step signup wizard
- **`api/create-wedding.js`** - Creates wedding profile after signup

### Signup Flow:

```
User Journey:
welcome-v2.html ‚Üí onboarding-v2.html ‚Üí create-wedding API ‚Üí dashboard-v2.html
```

### Detailed Flow:

**Step 1: Email & Password** (`onboarding-v2.html` lines 23-45)
```javascript
// Slide 1: Collect email and password
<input type="email" id="email" placeholder="you@example.com" required>
<input type="password" id="password" placeholder="Choose a secure password" required>
```

**Step 2-5: Collect wedding details**
- Full name
- About the couple
- Engagement date
- Planning status

**Step 6: Create Supabase account** (lines 365-384)
```javascript
async function createAccount() {
  const { data, error } = await supabase.auth.signUp({
    email: onboardingData.email,
    password: onboardingData.password,
    options: {
      data: {
        full_name: onboardingData.fullName  // Stored in auth.users metadata
      }
    }
  });

  if (error) throw error;
  console.log('Account created:', data);
}
```

**Step 7: Create wedding profile** (lines 387-426)
```javascript
async function createWedding() {
  // Get authenticated user
  const { data: { user }, error: authError } = await supabase.auth.getUser();

  if (authError || !user) {
    alert('You must be logged in to create a wedding profile.');
    window.location.href = 'login-v2.html';
    return;
  }

  // Call API to create wedding
  const response = await fetch('/api/create-wedding', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      ...onboardingData,
      userId: user.id  // ‚ö†Ô∏è User ID sent in request body
    })
  });

  // Redirect to subscription page
  window.location.href = 'subscribe-v2.html?wedding_id=' + data.wedding_id;
}
```

### Data Collected:
- ‚úÖ Email (required)
- ‚úÖ Password (required, min 6 chars)
- ‚úÖ Full name (stored in `auth.users.raw_user_meta_data`)
- ‚úÖ Wedding details (aboutUs, engagementDate, planningStatus)

### Data Storage:
- **Supabase Auth Table:** `auth.users`
  - Email (encrypted)
  - Password (bcrypt hashed by Supabase)
  - Metadata: `{ full_name: "User Name" }`

- **Custom Tables:**
  - `wedding_profiles` - Wedding details
  - `wedding_members` - User-wedding relationships

### Email Verification:
- ‚ùå **NOT ENABLED** - Users can signup without email verification
- üî¥ **RISK:** Fake emails can be used

### Security Notes:
- ‚úÖ Passwords hashed by Supabase (bcrypt)
- ‚úÖ Email validated client-side (format check)
- ‚úÖ Password min length: 6 characters
- ‚ö†Ô∏è No password strength requirements (uppercase, numbers, symbols)
- ‚ö†Ô∏è No CAPTCHA to prevent bot signups

---

## 2. LOGIN

### Files Involved:
- **`public/login-v2.html`** - Login form

### Login Flow:

```javascript
// login-v2.html lines 48-83
async function login(event) {
  event.preventDefault();

  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  try {
    // Supabase handles authentication
    const { data, error } = await supabase.auth.signInWithPassword({
      email: email,
      password: password,
    });

    if (error) throw error;

    // Get user's wedding
    const { data: member, error: memberError } = await supabase
      .from('wedding_members')
      .select('wedding_id')
      .eq('user_id', data.user.id)
      .single();

    if (memberError) throw memberError;

    // Redirect to dashboard
    window.location.href = `dashboard-v2.html?wedding_id=${member.wedding_id}`;

  } catch (error) {
    console.error('Login error:', error);
    alert('Error signing in. Please check your credentials and try again.');
  }
}
```

### Authentication Method:
- **Type:** Email/Password via Supabase Auth
- **API:** `supabase.auth.signInWithPassword()`
- **Session:** JWT token stored in localStorage by Supabase SDK

### Supported Methods:
- ‚úÖ Email/Password
- ‚ùå Magic Link (not implemented)
- ‚ùå OAuth (Google, GitHub, etc. - not implemented)
- ‚ùå Phone/SMS (not implemented)

### Session Token:
- **Storage:** `localStorage` (managed by Supabase SDK)
- **Key:** `sb-<project-ref>-auth-token`
- **Format:** JWT (JSON Web Token)
- **Expiration:** Managed by Supabase (default: 1 hour access token, 7 days refresh token)

### Error Handling:
- ‚úÖ Displays generic error message
- ‚úÖ Prevents information leakage ("check your credentials" - doesn't say which is wrong)

### Missing Features:
- ‚ùå "Forgot Password" link
- ‚ùå "Remember Me" option
- ‚ùå Password visibility toggle
- ‚ùå Failed login attempt tracking
- ‚ùå Account lockout after N failed attempts

---

## 3. SESSION MANAGEMENT

### Storage Method:
**Supabase handles session management automatically via localStorage:**

```javascript
// Stored by Supabase SDK in localStorage
Key: 'sb-nluvnjydydotsrpluhey-auth-token'
Value: {
  access_token: "eyJhbGc...",  // JWT - valid for 1 hour
  refresh_token: "...",         // Valid for 7 days
  expires_at: 1729800000,
  user: { id, email, ... }
}
```

### Authentication State Check:

**Pattern used across all protected pages:**

```javascript
// Example from dashboard-v2.html lines 115-120
async function loadWeddingData() {
  // Check if user is authenticated
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    // Not authenticated - redirect to welcome page
    window.location.href = 'welcome-v2.html';
    return;
  }

  // User is authenticated - continue loading data
  // ...
}
```

### Protected Routes:

All these pages check authentication on load:
- ‚úÖ `dashboard-v2.html` (lines 115-120)
- ‚úÖ `bestie-v2.html` (likely similar check)
- ‚úÖ `notifications-v2.html` (likely similar check)
- ‚úÖ `invite-v2.html` (likely similar check)
- ‚úÖ `subscribe-v2.html` (likely similar check)

### Session Persistence:
- **Persist:** Yes, via localStorage
- **Cross-tab:** Yes, Supabase SDK syncs across tabs
- **Expires:** Access token: 1 hour, Refresh token: 7 days

### Token Refresh:
```javascript
// Supabase SDK automatically refreshes tokens
// When access_token expires, it uses refresh_token to get new access_token
// This happens transparently in the background
```

### Auto-Refresh Logic:
- ‚úÖ **Handled by Supabase SDK** - Automatic token refresh before expiration
- ‚úÖ Refresh happens when calling `supabase.auth.getUser()` or `supabase.auth.getSession()`
- ‚ö†Ô∏è No visible "session about to expire" warning to user

### What Happens When Token Expires:
1. Access token expires after 1 hour
2. Supabase SDK automatically uses refresh_token to get new access_token
3. If refresh_token also expired (after 7 days):
   - User is logged out
   - Next API call fails
   - User redirected to login

### Session Timeout Handling:
```javascript
// If session expires and user tries to access protected page:
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  // Session expired - redirect to login
  window.location.href = 'welcome-v2.html';
  return;
}
```

---

## 4. PROTECTED API ENDPOINTS

### Authentication Patterns:

#### ‚úÖ **GOOD PATTERN** - Proper Authentication

**Used by most newer endpoints:**

```javascript
// Example from api/chat.js, api/accept-invite.js, api/create-invite.js
export default async function handler(req, res) {
  const { userToken } = req.body;

  if (!userToken) {
    return res.status(400).json({ error: 'Missing user token' });
  }

  try {
    // Create Supabase client with user's token
    const supabaseUser = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_ANON_KEY,
      {
        global: {
          headers: {
            Authorization: `Bearer ${userToken}`
          }
        }
      }
    );

    // Verify user authentication
    const { data: { user }, error: authError } = await supabaseUser.auth.getUser();

    if (authError || !user) {
      return res.status(401).json({ error: 'Unauthorized - invalid or expired token' });
    }

    // User is authenticated - proceed with operation
    // user.id is verified and can be trusted
    // ...
  } catch (error) {
    return res.status(500).json({ error: 'Internal server error' });
  }
}
```

**Endpoints using this pattern:**
- ‚úÖ `api/chat.js` (lines 14-37)
- ‚úÖ `api/bestie-chat.js` (likely similar)
- ‚úÖ `api/accept-invite.js` (lines 49-67)
- ‚úÖ `api/create-invite.js` (lines 56-74)
- ‚úÖ `api/get-my-bestie-permissions.js`
- ‚úÖ `api/update-my-inviter-access.js`

#### üî¥ **BAD PATTERN** - No Authentication

**CRITICAL VULNERABILITY:**

```javascript
// api/create-wedding.js - SECURITY ISSUE
export default async function handler(req, res) {
  const { userId } = req.body;  // ‚ö†Ô∏è TRUSTS userId FROM REQUEST

  if (!userId) {
    return res.status(400).json({ error: 'User ID required' });
  }

  // ‚ö†Ô∏è NO AUTHENTICATION CHECK
  // Anyone can call this endpoint with any userId
  // and create a wedding for that user!

  // Uses service_role directly
  const supabase = createClient(
    process.env.SUPABASE_URL,
    process.env.SUPABASE_SERVICE_ROLE_KEY  // ‚ö†Ô∏è Bypasses RLS
  );

  // Creates wedding without verifying caller
  await supabase.from('wedding_profiles').insert({
    owner_id: userId  // ‚ö†Ô∏è UNVERIFIED
  });
}
```

**RISK:**
- üî¥ **HIGH** - Attacker can create wedding for any user
- üî¥ Attacker can spam the database
- üî¥ No rate limiting

**Endpoints with this vulnerability:**
- üî¥ `api/create-wedding.js` - **CRITICAL**

#### ‚ÑπÔ∏è **PUBLIC PATTERN** - Intentionally No Auth

**Used by endpoints that should be public:**

```javascript
// api/get-invite-info.js - PUBLIC BY DESIGN
export default async function handler(req, res) {
  const { invite_token } = req.query;

  // No authentication required - public endpoint
  // Users need to view invite details before logging in

  const { data: invite } = await supabaseAdmin
    .from('invite_codes')
    .select('*')
    .eq('invite_token', invite_token)
    .single();

  // Returns limited public info only
  return res.json({
    wedding_name: invite.wedding_name,
    role: invite.role
    // No sensitive data exposed
  });
}
```

**Endpoints that are intentionally public:**
- ‚ÑπÔ∏è `api/get-invite-info.js` - ‚úÖ Correct (users need to see invite before signup)
- ‚ÑπÔ∏è `api/stripe-webhook.js` - ‚úÖ Correct (Stripe webhooks verified via signature)

### Service Role vs Anon Key:

**Service Role Key:**
```javascript
// Used for admin operations (bypasses RLS)
const supabaseAdmin = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY  // Full access
);
```

**Anon Key with User Token:**
```javascript
// Used for authenticated user operations (respects RLS)
const supabaseUser = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_ANON_KEY,
  {
    global: {
      headers: {
        Authorization: `Bearer ${userToken}`  // User's JWT
      }
    }
  }
);
```

**Current Usage:**
- ‚úÖ Most endpoints use service_role for admin operations AFTER verifying user
- üî¥ `create-wedding.js` uses service_role WITHOUT verifying user

---

## 5. LOGOUT

### Files Involved:
- **`public/dashboard-v2.html`** - Logout button in menu

### Logout Flow:

```javascript
// dashboard-v2.html lines 381-384
async function logout() {
  // Supabase handles session cleanup
  await supabase.auth.signOut();

  // Redirect to welcome page
  window.location.href = 'welcome-v2.html';
}
```

### What Gets Cleared:

**By `supabase.auth.signOut()`:**
- ‚úÖ Access token removed from localStorage
- ‚úÖ Refresh token removed from localStorage
- ‚úÖ User session invalidated on Supabase server
- ‚úÖ Supabase SDK internal state cleared

### Other Cleanup:
- ‚ö†Ô∏è No explicit clearing of other localStorage items
- ‚ö†Ô∏è No clearing of sessionStorage
- ‚ö†Ô∏è No clearing of cookies (none used for auth)

### Security Notes:
- ‚úÖ Proper logout via Supabase SDK
- ‚úÖ Session invalidated on server
- ‚ö†Ô∏è Could add cleanup for any cached wedding data

---

## 6. USER CONTEXT

### How App Knows Current User:

**Pattern used throughout app:**

```javascript
// Step 1: Get authenticated user
const { data: { user }, error } = await supabase.auth.getUser();

if (!user) {
  // Not authenticated
  window.location.href = 'welcome-v2.html';
  return;
}

// Step 2: Use user.id to query user's data
const { data: membership } = await supabase
  .from('wedding_members')
  .select('wedding_id')
  .eq('user_id', user.id)
  .single();

// Step 3: Load wedding data
const { data: wedding } = await supabase
  .from('wedding_profiles')
  .select('*')
  .eq('id', membership.wedding_id)
  .single();
```

### User Data Available:

```javascript
// From supabase.auth.getUser()
user = {
  id: "uuid",                    // User's unique ID
  email: "user@example.com",     // Email
  email_confirmed_at: null,      // ‚ö†Ô∏è No email verification
  created_at: "2025-10-24...",   // Account creation
  user_metadata: {
    full_name: "User Name"       // Custom metadata from signup
  },
  role: "authenticated",         // Supabase role
  aud: "authenticated"
}
```

### User ID Retrieval:

**Frontend:**
```javascript
const { data: { user } } = await supabase.auth.getUser();
const userId = user.id;
```

**API (after authentication):**
```javascript
const { data: { user } } = await supabaseUser.auth.getUser();
const userId = user.id;  // Verified and trusted
```

### getCurrentUser() Helper:

‚ùå **NOT IMPLEMENTED** - No centralized helper function

**Recommendation:**
```javascript
// Could create shared auth utility
async function getCurrentUser() {
  const { data: { user }, error } = await supabase.auth.getUser();

  if (error || !user) {
    throw new Error('Not authenticated');
  }

  return user;
}

// Usage:
try {
  const user = await getCurrentUser();
  // Use user.id
} catch (error) {
  // Redirect to login
  window.location.href = 'welcome-v2.html';
}
```

---

## 7. SECURITY AUDIT

### Password Security:

‚úÖ **GOOD:**
- Passwords hashed by Supabase using bcrypt
- Never stored in plain text
- Never sent in API responses
- Hash algorithm is industry-standard

‚ö†Ô∏è **IMPROVEMENTS NEEDED:**
- No password strength requirements
- No uppercase/lowercase/number/symbol requirements
- Minimum length only 6 characters (should be 12+)
- No password strength meter on signup
- No "password is commonly used" check

### RLS (Row Level Security):

**Expected RLS policies should enforce:**
- Users can only see their own wedding data
- Users can only modify weddings they belong to
- Invites can only be created by wedding owners
- Chat messages belong to specific users

‚ö†Ô∏è **VERIFICATION NEEDED:**
```sql
-- Need to verify these policies exist:
ALTER TABLE wedding_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE wedding_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE invite_codes ENABLE ROW LEVEL SECURITY;
ALTER TABLE chat_messages ENABLE ROW LEVEL SECURITY;

-- Example policy (verify these exist):
CREATE POLICY "Users can view own wedding"
  ON wedding_profiles FOR SELECT
  USING (
    id IN (
      SELECT wedding_id FROM wedding_members
      WHERE user_id = auth.uid()
    )
  );
```

### API Key Exposure:

‚úÖ **SUPABASE ANON KEY:**
- Hardcoded in frontend HTML files ‚úÖ **EXPECTED**
- The anon key is meant to be public
- Security enforced via RLS policies
- No sensitive data accessible with anon key alone

üî¥ **SUPABASE SERVICE KEY:**
- ‚úÖ Stored in environment variables (not in git)
- ‚úÖ Not exposed in frontend
- ‚úÖ Only used in API functions
- ‚ö†Ô∏è Ensure Vercel env vars are properly configured

‚úÖ **STRIPE KEYS:**
- Stored in environment variables
- Not exposed in frontend
- Webhook secret properly secured

‚úÖ **ANTHROPIC API KEY:**
- Stored in environment variables
- Not exposed in frontend

### CSRF Protection:

‚ö†Ô∏è **NOT IMPLEMENTED:**
- No CSRF tokens on forms
- Relying on same-origin policy
- Supabase Auth provides some protection via JWT

**Risk:** Medium (JWT validation provides some protection)

### XSS Protection:

‚ö†Ô∏è **NEEDS REVIEW:**
- User-generated content (wedding details, chat messages)
- Need to verify all user input is sanitized before rendering
- Check if Supabase auto-escapes or if manual escaping needed

### SQL Injection:

‚úÖ **PROTECTED:**
- Using Supabase client library
- All queries use parameterized queries
- No raw SQL string concatenation observed

### Rate Limiting:

‚ùå **NOT IMPLEMENTED:**
- No rate limiting on signup
- No rate limiting on login attempts
- No rate limiting on API endpoints

**Risk:**
- üî¥ Brute force attacks possible
- üî¥ Spam account creation possible
- üî¥ API abuse possible

**Recommendation:** Implement Vercel Edge Config rate limiting

### Session Hijacking:

‚ö†Ô∏è **PARTIAL PROTECTION:**
- JWT tokens in localStorage (vulnerable to XSS)
- No httpOnly cookies
- No SameSite cookie protection
- No session binding to IP/user-agent

**Risk:** Medium (if XSS vulnerability exists)

### Authentication Bypass:

üî¥ **CRITICAL VULNERABILITY FOUND:**

**`api/create-wedding.js` can be called by anyone:**

```bash
# Attacker can create wedding for any user
curl -X POST https://bridebuddyv2.vercel.app/api/create-wedding \
  -H "Content-Type: application/json" \
  -d '{"userId": "any-user-id-here", "weddingDate": "2025-12-25"}'
```

**Fix Required:**
```javascript
// BEFORE (vulnerable):
const { userId } = req.body;

// AFTER (secure):
const { userToken } = req.body;
const supabaseUser = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_ANON_KEY,
  {
    global: {
      headers: { Authorization: `Bearer ${userToken}` }
    }
  }
);

const { data: { user }, error } = await supabaseUser.auth.getUser();
if (error || !user) {
  return res.status(401).json({ error: 'Unauthorized' });
}

const userId = user.id;  // Now verified
```

---

## 8. MISSING FEATURES

### Critical Missing Features:

1. ‚ùå **Email Verification**
   - Users can signup with fake emails
   - No email confirmation required
   - Risk: Spam accounts, invalid contacts

2. ‚ùå **Password Reset**
   - No "Forgot Password" flow
   - Users locked out if they forget password
   - Need admin intervention to reset

3. ‚ùå **Account Recovery**
   - No way to recover account
   - No backup email or phone

4. ‚ùå **Rate Limiting**
   - No protection against brute force
   - No protection against spam signups
   - No API abuse protection

5. ‚ùå **Session Timeout Warning**
   - No warning before session expires
   - User work could be lost

6. ‚ùå **2FA / MFA**
   - No two-factor authentication
   - Single point of failure

### Nice-to-Have Features:

1. ‚ö†Ô∏è **OAuth Social Login**
   - Google, Facebook, Apple login
   - Easier signup, better security

2. ‚ö†Ô∏è **Magic Link Login**
   - Passwordless login via email
   - Better UX for some users

3. ‚ö†Ô∏è **Account Settings Page**
   - Change password
   - Update email
   - Delete account
   - Privacy settings

4. ‚ö†Ô∏è **Login History**
   - Show recent logins
   - Device tracking
   - Suspicious activity alerts

5. ‚ö†Ô∏è **Account Deletion**
   - GDPR compliance
   - Data export before deletion

---

## 9. AUTHENTICATION FLOW DIAGRAM

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ NEW USER FLOW                                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

welcome-v2.html
      ‚îÇ
      ‚îú‚îÄ‚Üí "Start Your Wedding"
      ‚îÇ
      ‚ñº
onboarding-v2.html
      ‚îÇ
      ‚îú‚îÄ‚Üí [SLIDE 1] Email + Password
      ‚îÇ   ‚îî‚îÄ‚Üí supabase.auth.signUp()
      ‚îÇ       ‚îú‚îÄ‚Üí Creates auth.users record
      ‚îÇ       ‚îú‚îÄ‚Üí Hashes password (bcrypt)
      ‚îÇ       ‚îú‚îÄ‚Üí Stores metadata {full_name}
      ‚îÇ       ‚îî‚îÄ‚Üí ‚ö†Ô∏è NO email verification
      ‚îÇ
      ‚îú‚îÄ‚Üí [SLIDES 2-6] Collect wedding data
      ‚îÇ
      ‚îú‚îÄ‚Üí [SLIDE 7] Loading...
      ‚îÇ
      ‚ñº
POST /api/create-wedding
      ‚îÇ
      ‚îú‚îÄ‚Üí ‚ö†Ô∏è VULNERABILITY: No auth check
      ‚îÇ   ‚îî‚îÄ‚Üí Trusts userId from request
      ‚îÇ
      ‚îú‚îÄ‚Üí Creates wedding_profiles
      ‚îî‚îÄ‚Üí Creates wedding_members (owner)
      ‚îÇ
      ‚ñº
subscribe-v2.html?wedding_id=xxx
      ‚îÇ
      ‚îî‚îÄ‚Üí User sets up payment/trial


‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ RETURNING USER FLOW                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

welcome-v2.html
      ‚îÇ
      ‚îú‚îÄ‚Üí "Returning"
      ‚îÇ
      ‚ñº
login-v2.html
      ‚îÇ
      ‚îú‚îÄ‚Üí Email + Password
      ‚îÇ
      ‚ñº
supabase.auth.signInWithPassword()
      ‚îÇ
      ‚îú‚îÄ‚Üí Validates credentials
      ‚îú‚îÄ‚Üí Returns JWT tokens
      ‚îÇ   ‚îú‚îÄ‚Üí access_token (1 hour)
      ‚îÇ   ‚îî‚îÄ‚Üí refresh_token (7 days)
      ‚îÇ
      ‚îú‚îÄ‚Üí Stored in localStorage
      ‚îÇ   ‚îî‚îÄ‚Üí Key: 'sb-<ref>-auth-token'
      ‚îÇ
      ‚îú‚îÄ‚Üí Query wedding_members
      ‚îÇ   ‚îî‚îÄ‚Üí Get user's wedding_id
      ‚îÇ
      ‚ñº
dashboard-v2.html?wedding_id=xxx
      ‚îÇ
      ‚îú‚îÄ‚Üí On load: Check auth
      ‚îÇ   ‚îî‚îÄ‚Üí supabase.auth.getUser()
      ‚îÇ       ‚îú‚îÄ‚Üí If no user ‚Üí redirect to welcome
      ‚îÇ       ‚îî‚îÄ‚Üí If user exists ‚Üí load dashboard
      ‚îÇ
      ‚îî‚îÄ‚Üí All interactions require auth


‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SESSION LIFECYCLE                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Login
  ‚îÇ
  ‚ñº
localStorage:
  sb-<ref>-auth-token: {
    access_token: "eyJhbGc...",  ‚Üê Valid 1 hour
    refresh_token: "...",        ‚Üê Valid 7 days
    expires_at: timestamp
  }
  ‚îÇ
  ‚îú‚îÄ‚Üí Access token expires (1 hour)
  ‚îÇ   ‚îî‚îÄ‚Üí Supabase SDK auto-refreshes using refresh_token
  ‚îÇ       ‚îî‚îÄ‚Üí Gets new access_token
  ‚îÇ
  ‚îú‚îÄ‚Üí Refresh token expires (7 days)
  ‚îÇ   ‚îî‚îÄ‚Üí User logged out
  ‚îÇ       ‚îî‚îÄ‚Üí Next getUser() returns null
  ‚îÇ           ‚îî‚îÄ‚Üí Redirect to welcome-v2.html
  ‚îÇ
  ‚îî‚îÄ‚Üí User clicks "Sign Out"
      ‚îî‚îÄ‚Üí supabase.auth.signOut()
          ‚îú‚îÄ‚Üí Clears localStorage
          ‚îú‚îÄ‚Üí Invalidates session on server
          ‚îî‚îÄ‚Üí Redirect to welcome-v2.html


‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ API AUTHENTICATION FLOW                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Frontend Call:
  ‚îÇ
  ‚îú‚îÄ‚Üí Get user token from Supabase
  ‚îÇ   const { data: { session } } = await supabase.auth.getSession();
  ‚îÇ   const userToken = session.access_token;
  ‚îÇ
  ‚îú‚îÄ‚Üí Send to API
  ‚îÇ   fetch('/api/chat', {
  ‚îÇ     body: JSON.stringify({
  ‚îÇ       message: "Hello",
  ‚îÇ       userToken: userToken  ‚Üê JWT token
  ‚îÇ     })
  ‚îÇ   })
  ‚îÇ
  ‚ñº
API Endpoint:
  ‚îÇ
  ‚îú‚îÄ‚Üí Extract userToken from request
  ‚îÇ
  ‚îú‚îÄ‚Üí Create Supabase client with token
  ‚îÇ   const supabaseUser = createClient(
  ‚îÇ     SUPABASE_URL,
  ‚îÇ     SUPABASE_ANON_KEY,
  ‚îÇ     { headers: { Authorization: `Bearer ${userToken}` } }
  ‚îÇ   );
  ‚îÇ
  ‚îú‚îÄ‚Üí Verify authentication
  ‚îÇ   const { data: { user }, error } = await supabaseUser.auth.getUser();
  ‚îÇ
  ‚îú‚îÄ‚Üí If error or !user
  ‚îÇ   ‚îî‚îÄ‚Üí return 401 Unauthorized
  ‚îÇ
  ‚îî‚îÄ‚Üí If user exists
      ‚îú‚îÄ‚Üí user.id is verified ‚úì
      ‚îî‚îÄ‚Üí Proceed with operation


‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ INVITE FLOW (Accept Invite)                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

User clicks invite link:
https://bridebuddyv2.vercel.app/accept-invite.html?token=abc123
  ‚îÇ
  ‚ñº
accept-invite.html
  ‚îÇ
  ‚îú‚îÄ‚Üí GET /api/get-invite-info?token=abc123
  ‚îÇ   ‚îî‚îÄ‚Üí ‚ÑπÔ∏è Public endpoint (no auth required)
  ‚îÇ       ‚îî‚îÄ‚Üí Returns wedding details
  ‚îÇ
  ‚îú‚îÄ‚Üí Display invite details
  ‚îÇ
  ‚îú‚îÄ‚Üí User not logged in?
  ‚îÇ   ‚îî‚îÄ‚Üí Show "Sign Up" / "Sign In" buttons
  ‚îÇ       ‚îî‚îÄ‚Üí User creates account / logs in
  ‚îÇ
  ‚îú‚îÄ‚Üí User clicks "Accept Invitation"
  ‚îÇ
  ‚ñº
POST /api/accept-invite
  ‚îÇ
  ‚îú‚îÄ‚Üí { invite_token, userToken }
  ‚îÇ
  ‚îú‚îÄ‚Üí ‚úÖ Verify userToken
  ‚îÇ   ‚îî‚îÄ‚Üí Get verified user.id
  ‚îÇ
  ‚îú‚îÄ‚Üí Validate invite
  ‚îÇ   ‚îú‚îÄ‚Üí Not used ‚úì
  ‚îÇ   ‚îú‚îÄ‚Üí Not expired ‚úì
  ‚îÇ   ‚îî‚îÄ‚Üí User not already member ‚úì
  ‚îÇ
  ‚îú‚îÄ‚Üí Add to wedding_members
  ‚îú‚îÄ‚Üí Mark invite as used
  ‚îÇ
  ‚îî‚îÄ‚Üí Redirect to dashboard
```

---

## 10. SECURITY RECOMMENDATIONS

### üî¥ CRITICAL (Fix Immediately):

**1. Fix `create-wedding.js` Authentication**
```javascript
// Current (VULNERABLE):
const { userId } = req.body;  // ‚ùå Unverified

// Fixed:
const { userToken } = req.body;
const { data: { user }, error } = await supabaseUser.auth.getUser(userToken);
if (error || !user) return res.status(401).json({ error: 'Unauthorized' });
const userId = user.id;  // ‚úÖ Verified
```
**Priority:** üî¥ **URGENT**
**Impact:** HIGH - Prevents unauthorized wedding creation
**Effort:** 30 minutes

---

### ‚ö†Ô∏è HIGH PRIORITY (Fix Soon):

**2. Implement Email Verification**
```javascript
// Enable in Supabase dashboard:
// Auth ‚Üí Email Templates ‚Üí Enable "Confirm signup"

// Update signup:
const { data, error } = await supabase.auth.signUp({
  email: email,
  password: password,
  options: {
    emailRedirectTo: 'https://bridebuddyv2.vercel.app/email-confirmed'
  }
});
```
**Priority:** ‚ö†Ô∏è HIGH
**Impact:** Prevents fake accounts
**Effort:** 2 hours

**3. Add Password Reset Flow**
```javascript
// login-v2.html - Add "Forgot Password" link
<a href="forgot-password.html">Forgot Password?</a>

// forgot-password.html - Send reset email
await supabase.auth.resetPasswordForEmail(email, {
  redirectTo: 'https://bridebuddyv2.vercel.app/reset-password'
});
```
**Priority:** ‚ö†Ô∏è HIGH
**Impact:** Users can recover accounts
**Effort:** 4 hours

**4. Implement Rate Limiting**
```javascript
// Use Vercel Edge Config or third-party service
// Limit: 5 login attempts per IP per 15 minutes
// Limit: 10 API calls per user per minute
```
**Priority:** ‚ö†Ô∏è HIGH
**Impact:** Prevents brute force and abuse
**Effort:** 6 hours

---

### ‚ÑπÔ∏è MEDIUM PRIORITY (Improvements):

**5. Add Password Strength Requirements**
```javascript
// Minimum 12 characters
// At least 1 uppercase, 1 lowercase, 1 number, 1 special char
// Check against common password list
```
**Priority:** ‚ÑπÔ∏è MEDIUM
**Impact:** Better account security
**Effort:** 2 hours

**6. Implement Session Timeout Warning**
```javascript
// Warn user 5 minutes before session expires
// Offer to extend session
// Auto-save work before timeout
```
**Priority:** ‚ÑπÔ∏è MEDIUM
**Impact:** Better UX, prevents data loss
**Effort:** 3 hours

**7. Add Account Settings Page**
```javascript
// Allow users to:
// - Change password
// - Update email
// - Delete account
// - View login history
```
**Priority:** ‚ÑπÔ∏è MEDIUM
**Impact:** User control and GDPR compliance
**Effort:** 8 hours

---

### üìã LOW PRIORITY (Nice-to-Have):

**8. Add OAuth Social Login**
```javascript
// Google, Facebook, Apple sign-in
// Easier onboarding, better security
```
**Priority:** üìã LOW
**Impact:** Better UX
**Effort:** 12 hours

**9. Implement 2FA/MFA**
```javascript
// SMS or authenticator app
// Enhanced security for sensitive accounts
```
**Priority:** üìã LOW
**Impact:** Maximum security
**Effort:** 16 hours

**10. Add Security Monitoring**
```javascript
// Log failed login attempts
// Alert on suspicious activity
// IP-based geolocation checks
```
**Priority:** üìã LOW
**Impact:** Detect attacks early
**Effort:** 8 hours

---

## 11. FILES REFERENCE

### Authentication Files:
- **`public/welcome-v2.html`** - Landing page (no auth required)
- **`public/login-v2.html`** - Login page with email/password form
- **`public/onboarding-v2.html`** - Signup wizard (7 slides)
- **`public/dashboard-v2.html`** - Protected page (auth check on load)
- **`public/accept-invite.html`** - Public invite page (auth optional)

### API Endpoints:
- **`api/create-wedding.js`** - üî¥ Vulnerable (no auth) - **FIX REQUIRED**
- **`api/chat.js`** - ‚úÖ Proper auth
- **`api/bestie-chat.js`** - ‚úÖ Proper auth
- **`api/accept-invite.js`** - ‚úÖ Proper auth
- **`api/create-invite.js`** - ‚úÖ Proper auth
- **`api/get-invite-info.js`** - ‚ÑπÔ∏è Public (by design)
- **`api/get-my-bestie-permissions.js`** - ‚úÖ Proper auth
- **`api/update-my-inviter-access.js`** - ‚úÖ Proper auth
- **`api/approve-update.js`** - ‚ö†Ô∏è Check auth
- **`api/create-checkout.js`** - ‚ö†Ô∏è Check auth
- **`api/stripe-webhook.js`** - ‚ÑπÔ∏è Public (verified via signature)

### Environment Variables:
- **`.env.example`** - Template (no secrets)
- **`.env`** - Not in repo ‚úÖ (Vercel env vars)

### Supabase Configuration:
- **Supabase URL:** `https://nluvnjydydotsrpluhey.supabase.co`
- **Anon Key:** Public (hardcoded in frontend) ‚úÖ Expected
- **Service Key:** Environment variable only ‚úÖ Secure

---

## 12. SUMMARY & ACTION ITEMS

### Overall Security Rating: ‚ö†Ô∏è **NEEDS IMPROVEMENT**

**Strengths:**
- ‚úÖ Using Supabase Auth (industry-standard)
- ‚úÖ Passwords properly hashed (bcrypt)
- ‚úÖ Most endpoints properly authenticated
- ‚úÖ API keys properly secured
- ‚úÖ JWT token management handled by Supabase

**Weaknesses:**
- üî¥ Critical: `create-wedding.js` has no authentication
- üî¥ No email verification enabled
- üî¥ No password reset flow
- üî¥ No rate limiting
- ‚ö†Ô∏è Weak password requirements
- ‚ö†Ô∏è No session timeout warnings

### Immediate Action Items:

**Week 1 (Critical):**
1. üî¥ Fix `api/create-wedding.js` authentication ‚Üê **DO THIS FIRST**
2. ‚ö†Ô∏è Enable email verification in Supabase
3. ‚ö†Ô∏è Implement password reset flow

**Week 2 (High Priority):**
4. ‚ö†Ô∏è Add rate limiting (login, signup, API)
5. ‚ÑπÔ∏è Strengthen password requirements
6. ‚ÑπÔ∏è Add session timeout warning

**Month 1 (Medium Priority):**
7. ‚ÑπÔ∏è Create account settings page
8. ‚ÑπÔ∏è Add security logging
9. ‚ÑπÔ∏è Verify RLS policies

**Future:**
10. üìã OAuth social login
11. üìã 2FA/MFA
12. üìã Advanced security monitoring

---

**End of Authentication Audit**
**Generated:** 2025-10-24
**Status:** ‚ö†Ô∏è Critical fix required for `create-wedding.js`
