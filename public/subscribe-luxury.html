<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Choose your Bride Buddy plan">
    <title>Bride Buddy - Choose Your Plan</title>

    <!-- Preconnect to font providers -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/styles-luxury.css">
    <link rel="stylesheet" href="/css/components-luxury.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-to-main">Skip to main content</a>

    <!-- Pricing Page Container -->
    <div class="bg-sunset">
        <div class="container" style="min-height: 100vh; padding-top: var(--space-12); padding-bottom: var(--space-12);">

            <!-- Header -->
            <div class="animate-fade-in" style="text-align: center; margin-bottom: var(--space-12);">
                <img src="/official-logo.png" alt="Bride Buddy" style="max-width: 300px; width: 100%; height: auto; margin: 0 auto var(--space-6); filter: drop-shadow(0 0 20px rgba(201, 169, 97, 0.3));">
                <h2 style="font-family: var(--font-heading); font-size: var(--text-3xl); color: var(--color-heading); margin-bottom: var(--space-2);">
                    Choose Your Plan
                </h2>
                <p style="color: var(--color-body); opacity: 0.9; font-size: var(--text-lg);">
                    Start your 7-day free trial. No credit card required!
                </p>
            </div>

            <!-- Pricing Cards -->
            <main id="main-content" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-8); max-width: 1000px; margin: 0 auto var(--space-12);">

                <!-- VIP Plan -->
                <div class="card card-champagne-accent animate-fade-in-scale" style="position: relative;">
                    <h3 style="font-family: var(--font-heading); font-size: var(--text-2xl); color: var(--color-navy); text-align: center; margin-bottom: var(--space-6);">
                        VIP
                    </h3>

                    <div style="text-align: center; margin-bottom: var(--space-6);">
                        <div style="font-size: var(--text-4xl); font-weight: 700; color: var(--color-gold);">
                            $12.99<span style="font-size: var(--text-lg); font-weight: 400; color: var(--color-burgundy);">/month</span>
                        </div>
                        <div style="color: var(--color-burgundy); opacity: 0.6; margin: var(--space-2) 0;">or</div>
                        <div style="font-size: var(--text-3xl); font-weight: 700; color: var(--color-gold);">
                            $99<span style="font-size: var(--text-base); font-weight: 400; color: var(--color-burgundy);"> one-time</span>
                        </div>
                    </div>

                    <ul style="list-style: none; padding: 0; margin: 0 0 var(--space-8) 0;">
                        <li style="padding: var(--space-2) 0; color: var(--color-navy); display: flex; align-items: start; gap: var(--space-2);">
                            <svg style="width: 20px; height: 20px; flex-shrink: 0; fill: var(--color-gold); margin-top: 2px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Full wedding planning tools
                        </li>
                        <li style="padding: var(--space-2) 0; color: var(--color-navy); display: flex; align-items: start; gap: var(--space-2);">
                            <svg style="width: 20px; height: 20px; flex-shrink: 0; fill: var(--color-gold); margin-top: 2px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Unlimited AI chat assistant
                        </li>
                        <li style="padding: var(--space-2) 0; color: var(--color-navy); display: flex; align-items: start; gap: var(--space-2);">
                            <svg style="width: 20px; height: 20px; flex-shrink: 0; fill: var(--color-gold); margin-top: 2px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Unlimited partners & co-planners
                        </li>
                        <li style="padding: var(--space-2) 0; color: var(--color-navy); display: flex; align-items: start; gap: var(--space-2);">
                            <svg style="width: 20px; height: 20px; flex-shrink: 0; fill: var(--color-gold); margin-top: 2px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Budget tracking
                        </li>
                        <li style="padding: var(--space-2) 0; color: var(--color-navy); display: flex; align-items: start; gap: var(--space-2);">
                            <svg style="width: 20px; height: 20px; flex-shrink: 0; fill: var(--color-gold); margin-top: 2px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Guest management
                        </li>
                        <li style="padding: var(--space-2) 0; color: var(--color-navy); display: flex; align-items: start; gap: var(--space-2);">
                            <svg style="width: 20px; height: 20px; flex-shrink: 0; fill: var(--color-gold); margin-top: 2px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Vendor coordination
                        </li>
                        <li style="padding: var(--space-2) 0; color: var(--color-navy); display: flex; align-items: start; gap: var(--space-2);">
                            <svg style="width: 20px; height: 20px; flex-shrink: 0; fill: var(--color-gold); margin-top: 2px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Task management
                        </li>
                    </ul>

                    <button class="btn btn-primary btn-full btn-lg" style="margin-bottom: var(--space-3);" onclick="selectPlan('vip', 'monthly')">
                        Start Free Trial
                    </button>
                    <button class="btn btn-secondary btn-full" onclick="selectPlan('vip', 'one_time')">
                        One-Time Payment
                    </button>
                </div>

                <!-- VIP + Bestie Plan -->
                <div class="card card-gold-accent animate-fade-in-scale" style="position: relative; animation-delay: 0.1s; border: 3px solid var(--color-gold);">
                    <div class="badge badge-gold" style="position: absolute; top: calc(var(--space-6) * -1); left: 50%; transform: translateX(-50%); white-space: nowrap;">
                        Recommended
                    </div>

                    <h3 style="font-family: var(--font-heading); font-size: var(--text-2xl); color: var(--color-navy); text-align: center; margin-bottom: var(--space-6); margin-top: var(--space-2);">
                        VIP + Bestie
                    </h3>

                    <div style="text-align: center; margin-bottom: var(--space-6);">
                        <div style="font-size: var(--text-4xl); font-weight: 700; color: var(--color-gold);">
                            $19.99<span style="font-size: var(--text-lg); font-weight: 400; color: var(--color-burgundy);">/month</span>
                        </div>
                        <div style="color: var(--color-burgundy); opacity: 0.6; margin: var(--space-2) 0;">or</div>
                        <div style="font-size: var(--text-3xl); font-weight: 700; color: var(--color-gold);">
                            $149<span style="font-size: var(--text-base); font-weight: 400; color: var(--color-burgundy);"> one-time</span>
                        </div>
                    </div>

                    <ul style="list-style: none; padding: 0; margin: 0 0 var(--space-8) 0;">
                        <li style="padding: var(--space-2) 0; color: var(--color-navy); display: flex; align-items: start; gap: var(--space-2); font-weight: 600;">
                            <svg style="width: 20px; height: 20px; flex-shrink: 0; fill: var(--color-gold); margin-top: 2px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Everything in VIP
                        </li>
                        <li style="padding: var(--space-2) 0; color: var(--color-navy); display: flex; align-items: start; gap: var(--space-2);">
                            <svg style="width: 20px; height: 20px; flex-shrink: 0; fill: var(--color-gold); margin-top: 2px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Separate Bestie interface
                        </li>
                        <li style="padding: var(--space-2) 0; color: var(--color-navy); display: flex; align-items: start; gap: var(--space-2);">
                            <svg style="width: 20px; height: 20px; flex-shrink: 0; fill: var(--color-gold); margin-top: 2px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Bachelorette party planning
                        </li>
                        <li style="padding: var(--space-2) 0; color: var(--color-navy); display: flex; align-items: start; gap: var(--space-2);">
                            <svg style="width: 20px; height: 20px; flex-shrink: 0; fill: var(--color-gold); margin-top: 2px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Bridal shower planning
                        </li>
                        <li style="padding: var(--space-2) 0; color: var(--color-navy); display: flex; align-items: start; gap: var(--space-2);">
                            <svg style="width: 20px; height: 20px; flex-shrink: 0; fill: var(--color-gold); margin-top: 2px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Bridesmaid tracker
                        </li>
                        <li style="padding: var(--space-2) 0; color: var(--color-navy); display: flex; align-items: start; gap: var(--space-2);">
                            <svg style="width: 20px; height: 20px; flex-shrink: 0; fill: var(--color-gold); margin-top: 2px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Payment tracking
                        </li>
                        <li style="padding: var(--space-2) 0; color: var(--color-navy); display: flex; align-items: start; gap: var(--space-2);">
                            <svg style="width: 20px; height: 20px; flex-shrink: 0; fill: var(--color-gold); margin-top: 2px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Bestie AI chat assistant
                        </li>
                    </ul>

                    <button class="btn btn-primary btn-full btn-lg" style="margin-bottom: var(--space-3);" onclick="selectPlan('vip_bestie', 'monthly')">
                        Start Free Trial
                    </button>
                    <button class="btn btn-secondary btn-full" onclick="selectPlan('vip_bestie', 'one_time')">
                        One-Time Payment
                    </button>
                </div>

            </main>

            <!-- Footer Note -->
            <p style="text-align: center; color: var(--color-body-muted); font-size: var(--text-sm);" class="animate-fade-in">
                7-day free trial included. Cancel anytime. No surprises.
            </p>

            <!-- Toast Container -->
            <div id="toastContainer" class="toast-container"></div>

        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initSupabase, showToast } from '/js/shared.js';

        // Initialize Supabase
        const supabase = initSupabase();

        // Get wedding_id from URL
        const urlParams = new URLSearchParams(window.location.search);
        const weddingId = urlParams.get('wedding_id');

        if (!weddingId) {
            showToast('No wedding ID found. Please complete onboarding first.', 'error');
            setTimeout(() => {
                window.location.href = 'index-luxury.html';
            }, 2000);
        }

        // Map tier + billing to Stripe Price IDs
        // TODO: Replace placeholder price IDs with real Stripe price IDs from your dashboard
        // Create these products in Stripe Dashboard → Products, then copy their price IDs here
        const PRICE_IDS = {
            'vip_monthly': 'price_1SHYkGDn8y3nIH6VnJNyAsE1',     // $12.99/month - ✓ CONFIGURED
            'vip_one_time': 'price_1SHYjrDn8y3nIH6VtE3aORiS',    // $99 one-time - ✓ CONFIGURED
            'vip_bestie_monthly': 'price_YOUR_BESTIE_MONTHLY',   // $19.99/month - ⚠️ NEEDS CONFIGURATION
            'vip_bestie_one_time': 'price_YOUR_BESTIE_ONETIME'   // $149 one-time - ⚠️ NEEDS CONFIGURATION
        };

        // Make function globally available
        window.selectPlan = async function(tier, billing) {
            try {
                // If "monthly" (Start Free Trial), enable the plan and go to dashboard
                if (billing === 'monthly') {
                    // Enable bestie addon if VIP+Bestie plan selected
                    if (tier === 'vip_bestie') {
                        const { data: { session } } = await supabase.auth.getSession();
                        if (session) {
                            // Enable bestie addon for trial
                            const { error } = await supabase
                                .from('wedding_profiles')
                                .update({ bestie_addon_enabled: true })
                                .eq('id', weddingId);

                            if (error) {
                                console.error('Error enabling bestie addon:', error);
                                showToast('Trial started, but bestie addon could not be enabled. Please contact support.', 'warning');
                            } else {
                                showToast('VIP+Bestie trial started! Bestie features enabled.', 'success');
                            }
                        }
                    }

                    window.location.href = `dashboard-luxury.html?wedding_id=${weddingId}`;
                    return;
                }

                // For one-time payment, go through Stripe checkout
                // SECURITY: Get session token to pass to server for verification
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    showToast('Please log in to continue.', 'error');
                    setTimeout(() => {
                        window.location.href = 'login-luxury.html';
                    }, 2000);
                    return;
                }

                // Get the price ID for this tier + billing combo
                const priceKey = `${tier}_${billing}`;
                const priceId = PRICE_IDS[priceKey];

                if (!priceId || priceId.startsWith('price_YOUR_')) {
                    showToast('This payment option is not yet configured. Please contact support or try the free trial.', 'warning');
                    return;
                }

                // SECURITY: Pass userToken (not userId) - server verifies ownership
                const response = await fetch('/api/create-checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        priceId: priceId,
                        userToken: session.access_token,
                        weddingId: weddingId
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || `API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                if (data.url) {
                    window.location.href = data.url;
                } else {
                    throw new Error('No checkout URL returned');
                }
            } catch (error) {
                console.error('Error selecting plan:', error);
                showToast('Error processing your selection. Please try again.', 'error');
            }
        };
    </script>

    <!-- Responsive Styles -->
    <style>
        @media (max-width: 768px) {
            main {
                grid-template-columns: 1fr !important;
            }

            .card {
                padding: var(--space-6) var(--space-4) !important;
            }
        }
    </style>
</body>
</html>
