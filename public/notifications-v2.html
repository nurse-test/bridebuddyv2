<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bride Buddy - Pending Approvals</title>
    <link rel="stylesheet" href="/css/styles-v2.css">
</head>
<body class="bg-bridal">
    <div class="screen">
        <div class="container">
            <!-- Header -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                <button class="nav-arrow" onclick="goBack()" style="background: rgba(212, 175, 55, 0.2); border-color: var(--gold); color: var(--navy);">
                    ‚Üê
                </button>
                <h2 style="color: var(--navy); font-family: var(--font-heading); margin: 0;">Pending Approvals</h2>
                <div style="width: 48px;"></div>
            </div>

            <!-- Pending Updates List -->
            <div id="pendingUpdatesList">
                <p class="text-navy" style="text-align: center; opacity: 0.7;">Loading...</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden">
                <div class="box-ivory text-center fade-in">
                    <h3 class="text-navy mb-md">üéâ All caught up!</h3>
                    <p class="text-navy" style="opacity: 0.7;">No pending approvals at the moment.</p>
                    <button class="btn btn-primary btn-full mt-lg" onclick="goBack()">
                        Back to Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Chat Modal -->
    <div id="chatModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;">
        <div class="box-ivory" style="max-width: 500px; width: 100%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 class="text-navy" style="margin: 0;">Update Request</h3>
                <button class="nav-arrow" onclick="closeModal()" style="background: rgba(212, 175, 55, 0.2); border-color: var(--gold); color: var(--navy);">
                    ‚úï
                </button>
            </div>
            
            <div id="modalContent">
                <!-- Content will be populated dynamically -->
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="approveUpdate()">
                    Approve
                </button>
                <button class="btn btn-secondary" style="flex: 1;" onclick="rejectUpdate()">
                    Reject
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabase = window.supabase.createClient(
            'https://nluvnjydydotsrpluhey.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sdXZuanlkeWRvdHNycGx1aGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NjE5MjAsImV4cCI6MjA3NjMzNzkyMH0.p5S8vYtZeYqp24avigifhjEDRaKv8TxJTaTkeLoE5mY'
        );

        const urlParams = new URLSearchParams(window.location.search);
        const weddingId = urlParams.get('wedding_id');
        let currentUpdateId = null;

        function goBack() {
            window.location.href = `dashboard-v2.html?wedding_id=${weddingId}`;
        }

        async function loadPendingUpdates() {
            try {
                const { data: updates, error } = await supabase
                    .from('pending_updates')
                    .select(`
                        *,
                        profiles (full_name, email)
                    `)
                    .eq('wedding_id', weddingId)
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const container = document.getElementById('pendingUpdatesList');
                const emptyState = document.getElementById('emptyState');
                
                if (!updates || updates.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                emptyState.classList.add('hidden');
                container.innerHTML = updates.map((update, index) => `
                    <div class="box-light-peach fade-in" style="margin-bottom: 16px; animation-delay: ${index * 0.1}s;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <div style="color: var(--navy); font-weight: 600; font-size: 1.125rem;">${update.profiles.full_name}</div>
                                <div style="color: var(--navy); opacity: 0.7; font-size: 0.875rem;">${getUpdateTypeLabel(update.update_type)}</div>
                            </div>
                            <span class="badge badge-warning">Pending</span>
                        </div>
                        
                        <div style="background: rgba(255, 255, 255, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="color: var(--navy); font-weight: 600; margin-bottom: 4px;">
                                ${update.task_name || update.description || 'Update request'}
                            </div>
                            ${update.amount ? `<div style="color: var(--navy); opacity: 0.8;">Amount: $${update.amount}</div>` : ''}
                        </div>
                        
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-sm" style="flex: 1;" onclick="viewChat('${update.id}')">
                                View Chat
                            </button>
                            <button class="btn btn-primary btn-sm" style="flex: 1;" onclick="quickApprove('${update.id}')">
                                Quick Approve
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading pending updates:', error);
            }
        }

        function getUpdateTypeLabel(type) {
            const labels = {
                'task_completion': 'Task Completion',
                'budget_payment': 'Budget Payment',
                'budget_edit': 'Budget Edit',
                'vendor_add': 'Vendor Addition'
            };
            return labels[type] || type;
        }

        async function viewChat(updateId) {
            try {
                const { data: update, error } = await supabase
                    .from('pending_updates')
                    .select('*, profiles (full_name)')
                    .eq('id', updateId)
                    .single();
                
                if (error) throw error;
                
                currentUpdateId = updateId;
                
                const modalContent = document.getElementById('modalContent');
                modalContent.innerHTML = `
                    <div style="background: rgba(156, 118, 198, 0.1); padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                        <div style="color: var(--navy); font-weight: 600; margin-bottom: 8px;">Task: ${update.task_name || 'N/A'}</div>
                        <div style="color: var(--navy); opacity: 0.8; margin-bottom: 8px;">Action: ${getUpdateTypeLabel(update.update_type)}</div>
                        ${update.amount ? `<div style="color: var(--navy); opacity: 0.8;">Amount: $${update.amount}</div>` : ''}
                    </div>
                    
                    ${update.trigger_message ? `
                        <div style="margin-bottom: 12px;">
                            <div style="color: var(--navy); font-weight: 600; margin-bottom: 4px;">${update.profiles.full_name}'s message:</div>
                            <div style="background: rgba(212, 175, 55, 0.1); padding: 12px; border-radius: 8px; color: var(--navy);">
                                "${update.trigger_message}"
                            </div>
                        </div>
                    ` : ''}
                    
                    ${update.ai_response ? `
                        <div>
                            <div style="color: var(--navy); font-weight: 600; margin-bottom: 4px;">AI response:</div>
                            <div style="background: rgba(156, 118, 198, 0.1); padding: 12px; border-radius: 8px; color: var(--navy);">
                                "${update.ai_response}"
                            </div>
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('chatModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading update details:', error);
            }
        }

        function closeModal() {
            document.getElementById('chatModal').classList.add('hidden');
            currentUpdateId = null;
        }

        async function quickApprove(updateId) {
            if (!confirm('Approve this update?')) return;
            
            await approveUpdateById(updateId);
        }

        async function approveUpdate() {
            if (!currentUpdateId) return;
            
            await approveUpdateById(currentUpdateId);
            closeModal();
        }

        async function approveUpdateById(updateId) {
            try {
                const response = await fetch('/api/approve-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        update_id: updateId,
                        action: 'approve',
                        wedding_id: weddingId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Update approved!');
                    loadPendingUpdates();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error approving update:', error);
                alert('Error approving update. Please try again.');
            }
        }

        async function rejectUpdate() {
            if (!currentUpdateId) return;
            
            if (!confirm('Reject this update? The co-planner will not be notified. We recommend reaching out to them directly.')) return;
            
            try {
                const response = await fetch('/api/approve-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        update_id: currentUpdateId,
                        action: 'reject',
                        wedding_id: weddingId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Update rejected. Please reach out to the co-planner to discuss.');
                    closeModal();
                    loadPendingUpdates();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error rejecting update:', error);
                alert('Error rejecting update. Please try again.');
            }
        }

        // Close modal when clicking outside
        document.getElementById('chatModal').addEventListener('click', (e) => {
            if (e.target.id === 'chatModal') {
                closeModal();
            }
        });

        // Initialize
        loadPendingUpdates();
    </script>
</body>
</html>
