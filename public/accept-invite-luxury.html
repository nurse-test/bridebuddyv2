<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Accept your wedding planning invitation">
    <title>Bride Buddy - Accept Invitation</title>

    <!-- Preconnect to font providers -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/styles-luxury.css">
    <link rel="stylesheet" href="/css/components-luxury.css">

</head>
<body>
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-to-main">Skip to main content</a>

    <!-- Accept Invite Page Container -->
    <div class="bg-sunset">
        <div class="container" style="min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding-top: var(--space-8); padding-bottom: var(--space-8);">

            <!-- Loading State -->
            <div id="loadingState" class="card card-gold-accent animate-fade-in" style="max-width: 480px; width: 100%; text-align: center;">
                <div class="loading-circle" style="width: 60px; height: 60px; margin: 0 auto var(--space-4); border: 4px solid rgba(201, 169, 97, 0.2); border-top-color: var(--color-gold); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p style="color: var(--color-navy);">Validating invite...</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden card card-rust-accent animate-fade-in" style="max-width: 480px; width: 100%; text-align: center;">
                <div style="font-size: var(--text-4xl); margin-bottom: var(--space-4);">‚ùå</div>
                <h3 style="font-family: var(--font-heading); font-size: var(--text-2xl); color: var(--color-navy); margin-bottom: var(--space-3);">
                    Invalid Invite
                </h3>
                <p id="errorMessage" style="color: var(--color-burgundy); margin-bottom: var(--space-6);"></p>
                <a href="login-luxury.html" class="btn btn-primary btn-lg">
                    Go to Login
                </a>
            </div>

            <!-- Invite Details -->
            <main id="main-content" class="hidden" style="max-width: 600px; width: 100%;">

                <!-- Header Card -->
                <div class="card card-gold-accent animate-fade-in" style="text-align: center; margin-bottom: var(--space-6);">
                    <div style="font-size: var(--text-4xl); margin-bottom: var(--space-4);">üíù</div>
                    <h1 style="font-family: var(--font-heading); font-size: var(--text-3xl); color: var(--color-navy); margin-bottom: var(--space-2);">
                        You're Invited!
                    </h1>
                    <p style="font-size: var(--text-lg); color: var(--color-navy); margin-bottom: var(--space-2);">
                        <span id="weddingName"></span>
                    </p>
                    <div class="badge badge-gold" id="roleBadge" style="margin-bottom: var(--space-2);"></div>
                    <p style="color: var(--color-burgundy); opacity: 0.8; font-size: var(--text-sm); margin-bottom: var(--space-1);">
                        Invited by <strong id="inviterName"></strong>
                    </p>
                    <p style="color: var(--color-burgundy); opacity: 0.6; font-size: var(--text-xs);">
                        Expires in <span id="expiresIn"></span>
                    </p>
                </div>

                <!-- Permissions Info -->
                <div class="card card-champagne-accent animate-fade-in" style="margin-bottom: var(--space-6); animation-delay: 0.1s;">
                    <h3 style="font-family: var(--font-heading); font-size: var(--text-xl); color: var(--color-navy); margin-bottom: var(--space-4);">
                        Your Access
                    </h3>
                    <div id="permissionsDisplay"></div>
                </div>

                <!-- Bestie Permissions (only for bestie role) -->
                <div id="bestiePermissionsSection" class="card card-rust-accent animate-fade-in hidden" style="margin-bottom: var(--space-6); animation-delay: 0.2s;">
                    <h3 style="font-family: var(--font-heading); font-size: var(--text-xl); color: var(--color-navy); margin-bottom: var(--space-3);">
                        Bestie Permissions
                    </h3>
                    <p style="color: var(--color-burgundy); opacity: 0.9; font-size: var(--text-sm); margin-bottom: var(--space-4);">
                        Control what the inviter can see in your private bestie planning space:
                    </p>

                    <label class="checkbox-item" style="margin-bottom: var(--space-3);">
                        <input type="checkbox" id="bestieReadPermission">
                        <span class="checkbox-label">
                            Allow inviter to <strong>view</strong> my bestie knowledge
                        </span>
                    </label>

                    <label class="checkbox-item">
                        <input type="checkbox" id="bestieEditPermission">
                        <span class="checkbox-label">
                            Allow inviter to <strong>edit</strong> my bestie knowledge
                        </span>
                    </label>

                    <p style="font-size: var(--text-xs); color: var(--color-burgundy); opacity: 0.6; margin-top: var(--space-3);">
                        You can change these permissions anytime from your settings.
                    </p>
                </div>

                <!-- Auth State: Not Logged In -->
                <div id="authPrompt" class="card card-gold-accent animate-fade-in hidden" style="text-align: center; animation-delay: 0.3s;">
                    <h3 style="font-family: var(--font-heading); font-size: var(--text-xl); color: var(--color-navy); margin-bottom: var(--space-3);">
                        Create Account or Sign In
                    </h3>
                    <p style="color: var(--color-burgundy); opacity: 0.9; margin-bottom: var(--space-6);">
                        To accept this invitation, you need to create an account or sign in.
                    </p>

                    <a id="signupLink" href="signup-luxury.html" class="btn btn-primary btn-lg btn-full" style="margin-bottom: var(--space-3);">
                        Create Account
                    </a>

                    <a id="loginLink" href="login-luxury.html" class="btn btn-secondary btn-lg btn-full">
                        Sign In
                    </a>

                    <p style="font-size: var(--text-xs); color: var(--color-burgundy); opacity: 0.6; margin-top: var(--space-4); text-align: center;">
                        This invite link will remain valid after you sign in.
                    </p>
                </div>

                <!-- Auth State: Logged In -->
                <div id="acceptPrompt" class="card card-gold-accent animate-fade-in hidden" style="text-align: center; animation-delay: 0.3s;">
                    <button id="acceptBtn" class="btn btn-primary btn-lg btn-full">
                        Accept Invitation
                    </button>

                    <p style="font-size: var(--text-sm); color: var(--color-burgundy); opacity: 0.6; margin-top: var(--space-4); text-align: center;">
                        By accepting, you'll join the wedding planning team.
                    </p>
                </div>

                <!-- Processing State -->
                <div id="processingState" class="card card-gold-accent animate-fade-in hidden" style="text-align: center; animation-delay: 0.3s;">
                    <div class="loading-circle" style="width: 60px; height: 60px; margin: 0 auto var(--space-4); border: 4px solid rgba(201, 169, 97, 0.2); border-top-color: var(--color-gold); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="color: var(--color-navy);">Accepting invitation...</p>
                </div>

                <!-- Success State -->
                <div id="successState" class="hidden card card-champagne-accent animate-fade-in" style="text-align: center;">
                    <div style="font-size: var(--text-4xl); margin-bottom: var(--space-4);">‚úì</div>
                    <h3 style="font-family: var(--font-heading); font-size: var(--text-2xl); color: var(--color-navy); margin-bottom: var(--space-3);">
                        Welcome!
                    </h3>
                    <p id="successMessage" style="color: var(--color-burgundy); margin-bottom: var(--space-2);"></p>
                    <p style="font-size: var(--text-sm); color: var(--color-burgundy); opacity: 0.7;">Redirecting to dashboard...</p>
                </div>

            </main>

            <!-- Toast Container -->
            <div id="toastContainer" class="toast-container"></div>

        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initSupabase, showToast } from '/js/shared.js';

        // Initialize Supabase
        const supabase = initSupabase();

        let inviteData = null;
        let inviteToken = null;

        // Initialize
        async function init() {
            // Get token from URL
            const urlParams = new URLSearchParams(window.location.search);
            inviteToken = urlParams.get('token');

            if (!inviteToken) {
                showError('No invite token provided');
                return;
            }

            // Validate invite
            await validateInvite();
        }

        // Validate Invite
        async function validateInvite() {
            try {
                const response = await fetch(`/api/get-invite-info?invite_token=${inviteToken}`);
                const data = await response.json();

                if (!response.ok || !data.is_valid) {
                    showError(data.error || 'Invalid invite link');
                    return;
                }

                inviteData = data.invite;
                displayInvite();
                await checkAuthState();

            } catch (error) {
                console.error('Validation error:', error);
                showError('Failed to validate invite');
            }
        }

        // Display Invite
        function displayInvite() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');

            // Set wedding name
            document.getElementById('weddingName').textContent = inviteData.wedding_name;

            // Set inviter name
            document.getElementById('inviterName').textContent = inviteData.inviter_name;

            // Set role badge
            const roleBadge = document.getElementById('roleBadge');
            roleBadge.textContent = inviteData.role_display;

            // Set expiration
            const expiresIn = inviteData.days_until_expiration > 0
                ? `${inviteData.days_until_expiration} day${inviteData.days_until_expiration !== 1 ? 's' : ''}`
                : `${inviteData.hours_until_expiration} hour${inviteData.hours_until_expiration !== 1 ? 's' : ''}`;
            document.getElementById('expiresIn').textContent = expiresIn;

            // Display permissions
            displayPermissions();

            // Show bestie permissions section if role is bestie
            if (inviteData.role === 'bestie') {
                document.getElementById('bestiePermissionsSection').classList.remove('hidden');

                // Add listener to enforce edit requires read
                const readCheckbox = document.getElementById('bestieReadPermission');
                const editCheckbox = document.getElementById('bestieEditPermission');

                editCheckbox.addEventListener('change', () => {
                    if (editCheckbox.checked) {
                        readCheckbox.checked = true;
                    }
                });

                readCheckbox.addEventListener('change', () => {
                    if (!readCheckbox.checked) {
                        editCheckbox.checked = false;
                    }
                });
            }
        }

        // Display Permissions
        function displayPermissions() {
            const permissionsDisplay = document.getElementById('permissionsDisplay');
            const canRead = inviteData.wedding_profile_permissions.read;
            const canEdit = inviteData.wedding_profile_permissions.edit;

            let html = '';

            const permissionItem = (icon, text, granted) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); background: rgba(255, 255, 255, 0.3); border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                    <span style="color: var(--color-navy); display: flex; align-items: center; gap: var(--space-2);">
                        <span style="font-size: var(--text-xl);">${icon}</span>
                        ${text}
                    </span>
                    <span style="color: ${granted ? 'var(--color-gold)' : 'var(--color-burgundy)'}; font-weight: 600;">
                        ${granted ? '‚úì' : '‚úó'}
                    </span>
                </div>
            `;

            if (inviteData.role === 'partner') {
                html += permissionItem('üëë', '<strong>Full Partner Access</strong>', true);
                html += permissionItem('üëÅÔ∏è', 'Can view and edit all wedding details', true);
                html += permissionItem('‚úâÔ∏è', 'Can invite additional team members', true);
            } else if (inviteData.role === 'bestie') {
                html += permissionItem('üíñ', '<strong>Bestie Access</strong>', true);
                html += permissionItem('ü§´', 'Private bestie planning space', true);
                html += permissionItem('üëÅÔ∏è', 'Can view wedding details', canRead);
                html += permissionItem('‚úèÔ∏è', 'Can edit wedding details', canEdit);
            } else { // co_planner
                html += permissionItem('ü§ù', '<strong>Co-planner Access</strong>', true);
                html += permissionItem('üëÅÔ∏è', 'Can view wedding details', canRead);
                html += permissionItem('‚úèÔ∏è', 'Can edit wedding details', canEdit);
            }

            permissionsDisplay.innerHTML = html;
        }

        // Check Auth State
        async function checkAuthState() {
            const { data: { session } } = await supabase.auth.getSession();

            if (session) {
                // User is logged in - show accept button
                document.getElementById('acceptPrompt').classList.remove('hidden');
                document.getElementById('acceptBtn').addEventListener('click', acceptInvite);
            } else {
                // User not logged in - show auth prompt with invite token in links
                const signupLink = document.getElementById('signupLink');
                const loginLink = document.getElementById('loginLink');

                if (inviteToken) {
                    signupLink.href = `signup-luxury.html?invite_token=${inviteToken}`;
                    loginLink.href = `login-luxury.html?invite_token=${inviteToken}`;
                }

                document.getElementById('authPrompt').classList.remove('hidden');
            }
        }

        // Accept Invite
        async function acceptInvite() {
            // Hide accept prompt, show processing
            document.getElementById('acceptPrompt').classList.add('hidden');
            document.getElementById('processingState').classList.remove('hidden');

            try {
                const { data: { session } } = await supabase.auth.getSession();

                if (!session) {
                    showError('Please log in to accept this invitation');
                    return;
                }

                // Get bestie permissions if role is bestie
                let bestiePermissions = { can_read: false, can_edit: false };
                if (inviteData.role === 'bestie') {
                    bestiePermissions = {
                        can_read: document.getElementById('bestieReadPermission').checked,
                        can_edit: document.getElementById('bestieEditPermission').checked
                    };
                }

                // Call accept API
                const response = await fetch('/api/accept-invite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        invite_token: inviteToken,
                        userToken: session.access_token,
                        bestie_knowledge_permissions: bestiePermissions
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    showError(result.error || 'Failed to accept invitation');
                    document.getElementById('processingState').classList.add('hidden');
                    document.getElementById('acceptPrompt').classList.remove('hidden');
                    return;
                }

                // Show success
                document.getElementById('processingState').classList.add('hidden');
                document.getElementById('successState').classList.remove('hidden');
                document.getElementById('successMessage').textContent = result.message;

                showToast('Invitation accepted successfully!', 'success');

                // Redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = result.redirect_to;
                }, 2000);

            } catch (error) {
                console.error('Accept error:', error);
                showError('Failed to accept invitation');
                document.getElementById('processingState').classList.add('hidden');
                document.getElementById('acceptPrompt').classList.remove('hidden');
            }
        }

        // Show Error
        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
            showToast(message, 'error');
        }

        // Initialize on page load
        init();
    </script>

    <!-- Custom Styles -->
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: var(--space-3);
            background: rgba(201, 169, 97, 0.12);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            background: rgba(201, 169, 97, 0.18);
            border-color: var(--color-accent);
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: var(--space-3);
            cursor: pointer;
        }

        .checkbox-label {
            color: var(--color-navy);
            font-weight: 500;
            flex: 1;
        }

        @media (max-width: 768px) {
            .card {
                padding: var(--space-4) !important;
            }
        }
    </style>
</body>
</html>
