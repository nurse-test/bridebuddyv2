<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Invite your partner and besties to help plan your wedding">
    <title>Bride Buddy - Invite Team</title>

    <!-- Preconnect to font providers -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/styles-luxury.css">
    <link rel="stylesheet" href="/css/components-luxury.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-to-main">Skip to main content</a>

    <!-- Invite Page Container -->
    <div class="bg-sunset">
        <div class="container" style="min-height: 100vh; padding-top: var(--space-8); padding-bottom: var(--space-8);">

            <!-- Header -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-8);" class="animate-fade-in">
                <button onclick="goBack()" class="btn btn-icon-only" style="background: rgba(201, 169, 97, 0.2); border-color: var(--color-gold);">
                    <svg style="width: 24px; height: 24px; fill: currentColor;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </button>
                <h2 style="font-family: var(--font-heading); font-size: var(--text-2xl); color: var(--color-navy); margin: 0;">
                    Invite Your Team
                </h2>
                <div style="width: 48px;"></div>
            </div>

            <!-- Main Content -->
            <main id="main-content" style="max-width: 800px; margin: 0 auto;">

                <!-- Invite Partner Card -->
                <div class="card card-gold-accent animate-fade-in" style="margin-bottom: var(--space-6);">
                    <h3 style="font-family: var(--font-heading); font-size: var(--text-xl); color: var(--color-navy); margin-bottom: var(--space-4);">
                        Invite Your Partner
                    </h3>
                    <p style="color: var(--color-burgundy); opacity: 0.8; margin-bottom: var(--space-6);">
                        Invite your fiancé(e) to co-manage the wedding planning. You'll both have your own AI chats that populate the same wedding details, vendors, budget, and tasks.
                    </p>

                    <button
                        onclick="createInvite('partner')"
                        id="invitePartnerBtn"
                        class="btn btn-primary btn-lg btn-full"
                        style="margin-bottom: var(--space-3);">
                        Invite Partner
                    </button>

                    <p id="partnerStatus" style="text-align: center; color: var(--color-burgundy); opacity: 0.7; font-size: var(--text-sm);"></p>
                </div>

                <!-- Invite Besties Card -->
                <div class="card card-champagne-accent animate-fade-in" style="margin-bottom: var(--space-6); animation-delay: 0.1s;">
                    <h3 style="font-family: var(--font-heading); font-size: var(--text-xl); color: var(--color-navy); margin-bottom: var(--space-4);">
                        Invite Your Besties
                    </h3>
                    <p style="color: var(--color-burgundy); opacity: 0.8; margin-bottom: var(--space-6);">
                        Invite your Maid of Honor or Best Man (max 2 total). Each bestie gets their own private planning space to organize bachelorette/bachelor parties and bridal showers.
                    </p>

                    <button
                        onclick="createInvite('bestie')"
                        id="inviteBestieBtn"
                        class="btn btn-primary btn-lg btn-full"
                        style="margin-bottom: var(--space-3);">
                        Invite Bestie
                    </button>

                    <p id="bestieStatus" style="text-align: center; color: var(--color-burgundy); opacity: 0.7; font-size: var(--text-sm);"></p>
                </div>

                <!-- Generated Link Display (shared) -->
                <div id="generatedLinkSection" class="hidden card card-rust-accent animate-fade-in" style="margin-bottom: var(--space-6);">
                    <h3 style="font-family: var(--font-heading); font-size: var(--text-xl); color: var(--color-navy); margin-bottom: var(--space-4);">
                        Share Invite Link
                    </h3>
                    <div style="background: rgba(255, 255, 255, 0.7); border: 2px dashed var(--color-rust); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">
                        <p style="font-weight: 600; color: var(--color-navy); margin-bottom: var(--space-2);">Share this link:</p>
                        <p id="inviteLink" style="font-size: var(--text-sm); color: var(--color-navy); word-break: break-all; margin-bottom: var(--space-3);"></p>
                        <button class="btn btn-secondary btn-full" onclick="copyLink()" id="copyBtn">
                            Copy Link
                        </button>
                    </div>
                    <p style="font-size: var(--text-sm); color: var(--color-burgundy); opacity: 0.6; text-align: center; margin-bottom: var(--space-3);">
                        Link expires in 7 days • One-time use only
                    </p>
                    <button class="btn btn-ghost btn-full" onclick="closeInviteSection()">
                        Done
                    </button>
                </div>

                <!-- Active Invite Links -->
                <div class="card card-accent animate-fade-in" style="margin-bottom: var(--space-6); animation-delay: 0.2s;">
                    <h3 style="font-family: var(--font-heading); font-size: var(--text-xl); color: var(--color-navy); margin-bottom: var(--space-6);">
                        Active Invite Links
                    </h3>
                    <div id="pendingInvites">
                        <p style="text-align: center; color: var(--color-burgundy); opacity: 0.7;">Loading...</p>
                    </div>
                </div>

                <!-- Current Members -->
                <div class="card animate-fade-in" style="animation-delay: 0.3s;">
                    <h3 style="font-family: var(--font-heading); font-size: var(--text-xl); color: var(--color-navy); margin-bottom: var(--space-6);">
                        Current Members
                    </h3>
                    <div id="currentMembers">
                        <p style="text-align: center; color: var(--color-burgundy); opacity: 0.7;">Loading...</p>
                    </div>
                </div>

            </main>

            <!-- Toast Container -->
            <div id="toastContainer" class="toast-container"></div>

        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initSupabase, showToast, getWeddingId } from '/js/shared.js';
        import { escapeHtml, sanitizeUrl } from '/js/security.js';

        // Initialize Supabase
        const supabase = initSupabase();

        // Wedding ID will be loaded from localStorage/URL/database
        let weddingId = null;
        let currentInviteUrl = '';

        // Make functions globally available
        window.goBack = function() {
            window.location.href = `dashboard-luxury.html?wedding_id=${weddingId}`;
        };

        // Create Invite (partner or bestie)
        window.createInvite = async function(role) {
            const btn = role === 'partner'
                ? document.getElementById('invitePartnerBtn')
                : document.getElementById('inviteBestieBtn');

            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Generating...';

            try {
                // Validate wedding_id exists
                if (!weddingId) {
                    showToast('No wedding ID found. Please access from dashboard.', 'error');
                    return;
                }

                // Get user session
                const { data: { session } } = await supabase.auth.getSession();

                if (!session) {
                    showToast('Please log in to create invites', 'error');
                    return;
                }

                const response = await fetch('/api/create-invite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userToken: session.access_token,
                        wedding_id: weddingId,
                        role: role
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));

                    // Provide user-friendly error messages
                    let userMessage = errorData.error || `Server error: ${response.status}`;

                    // Add helpful context for common errors
                    if (response.status === 400 && errorData.error?.includes('already has')) {
                        userMessage = errorData.error;  // Already user-friendly
                    } else if (response.status === 403) {
                        userMessage = 'You do not have permission to create invites for this wedding.';
                    } else if (response.status === 404) {
                        userMessage = 'Wedding not found. Please refresh and try again.';
                    } else if (response.status === 500) {
                        userMessage = `Failed to create invite: ${errorData.details || 'Server error'}`;
                    }

                    throw new Error(userMessage);
                }

                const data = await response.json();

                if (data.success) {
                    currentInviteUrl = data.invite_url;
                    document.getElementById('inviteLink').textContent = data.invite_url;
                    document.getElementById('generatedLinkSection').classList.remove('hidden');

                    // Scroll to invite link
                    document.getElementById('generatedLinkSection').scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });

                    loadPendingInvites();
                    checkInviteLimits();
                    showToast(data.message, 'success');
                } else {
                    throw new Error(data.error || 'Failed to create invite link');
                }
            } catch (error) {
                console.error('Error creating invite:', error);
                showToast(error.message || 'Error creating invite link. Please try again.', 'error', 5000);
            } finally {
                btn.disabled = false;
                btn.textContent = role === 'partner' ? 'Invite Partner' : 'Invite Bestie';
            }
        };

        // Copy Link
        window.copyLink = function() {
            navigator.clipboard.writeText(currentInviteUrl).then(() => {
                const btn = document.getElementById('copyBtn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.classList.add('btn-success');

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('btn-success');
                }, 2000);

                showToast('Link copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy link', 'error');
            });
        };

        // Close invite section
        window.closeInviteSection = function() {
            document.getElementById('generatedLinkSection').classList.add('hidden');
            currentInviteUrl = '';
        };

        // Check invite limits and update UI
        async function checkInviteLimits() {
            try {
                // Validate weddingId exists
                if (!weddingId) {
                    console.error('No wedding_id provided');
                    return;
                }

                const { data: members, error } = await supabase
                    .from('wedding_members')
                    .select('role')
                    .eq('wedding_id', weddingId);

                if (error) throw error;

                const hasPartner = members?.some(m => m.role === 'partner');
                const bestieCount = members?.filter(m => m.role === 'bestie').length || 0;

                // Update partner button
                const partnerBtn = document.getElementById('invitePartnerBtn');
                const partnerStatus = document.getElementById('partnerStatus');

                if (hasPartner) {
                    partnerBtn.disabled = true;
                    partnerBtn.textContent = '✓ Partner Invited';
                    partnerBtn.classList.remove('btn-primary');
                    partnerBtn.classList.add('btn-secondary');
                    partnerStatus.textContent = 'Your partner has been invited';
                } else {
                    partnerStatus.textContent = 'No partner invited yet';
                }

                // Update bestie button
                const bestieBtn = document.getElementById('inviteBestieBtn');
                const bestieStatus = document.getElementById('bestieStatus');

                bestieStatus.textContent = `${bestieCount}/2 besties invited`;

                if (bestieCount >= 2) {
                    bestieBtn.disabled = true;
                    bestieBtn.textContent = '✓ Maximum Besties Invited';
                    bestieBtn.classList.remove('btn-primary');
                    bestieBtn.classList.add('btn-secondary');
                }

            } catch (error) {
                console.error('Error checking limits:', error);
            }
        }

        // Load Pending Invites
        async function loadPendingInvites() {
            try {
                // Validate weddingId exists
                if (!weddingId) {
                    console.error('No wedding_id provided');
                    document.getElementById('pendingInvites').innerHTML =
                        '<p style="text-align: center; color: var(--color-burgundy); opacity: 0.7;">Please provide a valid wedding ID</p>';
                    return;
                }

                const { data: invites, error } = await supabase
                    .from('invite_codes')
                    .select('*')
                    .eq('wedding_id', weddingId)
                    .or('is_used.is.null,is_used.eq.false')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('pendingInvites');

                if (!invites || invites.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--color-burgundy); opacity: 0.7;">No active invite links</p>';
                    return;
                }

                // SECURITY: Escape all content to prevent XSS
                container.innerHTML = invites.map(invite => {
                    // Extract role from token: "partner_TOKEN" or "bestie_TOKEN"
                    const token = invite.invite_token || invite.code;
                    let role = invite.role || 'partner';  // Default from database

                    // If token has role encoded, extract it
                    if (token && token.includes('_')) {
                        const parts = token.split('_');
                        if (parts[0] === 'partner' || parts[0] === 'bestie') {
                            role = parts[0];
                        }
                    }

                    const roleDisplay = role === 'partner' ? 'Partner' : role === 'bestie' ? 'Bestie' : 'Team Member';
                    const roleColor = role === 'partner' ? 'var(--color-gold)' : 'var(--color-rust)';
                    const inviteUrl = sanitizeUrl(`${window.location.origin}/accept-invite-luxury.html?token=${escapeHtml(token)}`);

                    return `
                        <div style="background: rgba(255, 255, 255, 0.3); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-2);">
                                <div>
                                    <p style="font-weight: 600; color: var(--color-navy); margin-bottom: var(--space-1);">${escapeHtml(roleDisplay)}</p>
                                    <p style="font-size: var(--text-sm); color: var(--color-burgundy); opacity: 0.7;">
                                        One-time use link
                                    </p>
                                </div>
                                <span style="padding: 4px 12px; background: rgba(201, 169, 97, 0.1); color: ${roleColor}; font-size: var(--text-xs); border-radius: 12px; font-weight: 500;">
                                    Pending
                                </span>
                            </div>
                            <div style="background: rgba(0, 0, 0, 0.1); padding: var(--space-2); border-radius: var(--radius-sm); font-size: var(--text-xs); color: var(--color-navy); word-break: break-all; margin-bottom: var(--space-2);">
                                ${escapeHtml(inviteUrl)}
                            </div>
                            <button onclick="copyInviteLink('${escapeHtml(inviteUrl)}')" class="btn btn-secondary btn-sm btn-full">
                                Copy Link
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading invites:', error);
                document.getElementById('pendingInvites').innerHTML =
                    '<p style="text-align: center; color: var(--color-burgundy); opacity: 0.7;">Failed to load invites</p>';
            }
        }

        // Copy Specific Invite Link
        window.copyInviteLink = function(url) {
            navigator.clipboard.writeText(url).then(() => {
                showToast('Invite link copied!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy link', 'error');
            });
        };

        // Load Current Members
        async function loadCurrentMembers() {
            try {
                // Validate weddingId exists
                if (!weddingId) {
                    console.error('No wedding_id provided');
                    document.getElementById('currentMembers').innerHTML =
                        '<p style="text-align: center; color: var(--color-burgundy); opacity: 0.7;">Please provide a valid wedding ID</p>';
                    return;
                }

                const { data: members, error } = await supabase
                    .from('wedding_members')
                    .select('role, wedding_profile_permissions, user_id')
                    .eq('wedding_id', weddingId);

                if (error) throw error;

                const container = document.getElementById('currentMembers');

                if (!members || members.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--color-burgundy); opacity: 0.7;">No members yet</p>';
                    return;
                }

                // SECURITY: Escape role display for defense in depth
                container.innerHTML = members.map(member => {
                    const roleDisplayMap = {
                        'owner': 'Owner',
                        'partner': 'Partner',
                        'bestie': 'Bestie'
                    };
                    // Use mapped value or escape the database role value
                    const roleDisplay = roleDisplayMap[member.role] || escapeHtml(member.role);

                    const permissions = member.wedding_profile_permissions || {};
                    const permissionsText = member.role === 'owner'
                        ? 'Full access'
                        : member.role === 'partner'
                            ? 'Can edit'
                            : permissions.read
                                ? 'Can view'
                                : 'No access';

                    return `
                        <div style="background: rgba(201, 169, 97, 0.12); padding: var(--space-3); border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                            <div style="color: var(--color-navy); font-weight: 600;">${roleDisplay}</div>
                            <div style="color: var(--color-navy); opacity: 0.8; font-size: var(--text-sm); margin-top: var(--space-1);">
                                ${permissionsText}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading members:', error);
                document.getElementById('currentMembers').innerHTML =
                    '<p style="text-align: center; color: var(--color-burgundy); opacity: 0.7;">Failed to load members</p>';
            }
        }

        // Initialize page
        async function initializePage() {
            // Load wedding ID from localStorage/URL/database
            weddingId = await getWeddingId();

            // Check if weddingId exists
            if (!weddingId) {
                showToast('No wedding ID provided. Please access from dashboard.', 'error', 5000);
                setTimeout(() => {
                    window.location.href = 'dashboard-luxury.html';
                }, 2000);
                return;
            }

            // Check authentication
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                showToast('Please log in to manage invites', 'error');
                setTimeout(() => {
                    window.location.href = `login-luxury.html?returnTo=invite-luxury.html?wedding_id=${weddingId}`;
                }, 1500);
                return;
            }

            // Load all data
            await checkInviteLimits();
            await loadPendingInvites();
            await loadCurrentMembers();
        }

        // Initialize when page loads
        initializePage();
    </script>

    <!-- Custom Styles -->
    <style>
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: var(--space-3);
            background: rgba(201, 169, 97, 0.12);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            background: rgba(201, 169, 97, 0.18);
            border-color: var(--color-accent);
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: var(--space-3);
            cursor: pointer;
        }

        .checkbox-label {
            color: var(--color-navy);
            font-weight: 500;
            flex: 1;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-cream);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-success {
            background: #28a745 !important;
            border-color: #28a745 !important;
        }

        @media (max-width: 768px) {
            .card {
                padding: var(--space-4) !important;
            }
        }
    </style>
</body>
</html>
