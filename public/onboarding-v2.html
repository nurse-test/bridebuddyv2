<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bride Buddy - Getting Started</title>
    <link rel="stylesheet" href="/css/styles-v2.css">
</head>
<body class="bg-gradient">
    <div class="screen">
        <div class="container">
            <!-- Progress Dots -->
            <div class="progress-dots" id="progressDots">
                <div class="progress-dot active"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
            </div>

            <!-- SLIDE 1: Email & Password -->
            <div class="slide active" id="slide1">
                <div class="box-ivory slide-in-right">
                    <h2 class="text-navy text-center mb-md">Create Your Account</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="email" placeholder="you@example.com" required>
                        <div class="form-error" id="emailError">Please enter a valid email</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="password" placeholder="Choose a secure password" required>
                        <div class="form-error" id="passwordError">Password must be at least 6 characters</div>
                    </div>

                    <div class="nav-arrows">
                        <button class="nav-arrow" disabled>‹</button>
                        <button class="nav-arrow" onclick="nextSlide()">›</button>
                    </div>
                </div>
            </div>

            <!-- SLIDE 2: Your Name -->
            <div class="slide hidden" id="slide2">
                <div class="box-light-blue">
                    <h2 class="text-white text-center mb-md">What's your name?</h2>
                    
                    <div class="form-group">
                        <label class="form-label text-white">Full Name</label>
                        <input type="text" class="form-input" id="fullName" placeholder="Jane Smith" required>
                        <div class="form-error" id="nameError">Please enter your name</div>
                    </div>

                    <div class="nav-arrows">
                        <button class="nav-arrow" onclick="prevSlide()">‹</button>
                        <button class="nav-arrow" onclick="nextSlide()">›</button>
                    </div>
                </div>
            </div>

            <!-- SLIDE 3: About Us -->
            <div class="slide hidden" id="slide3">
                <div class="box-lavender">
                    <h2 class="text-navy text-center mb-md">Tell me about who's getting married!</h2>
                    
                    <div class="form-group">
                        <label class="form-label">About Us</label>
                        <textarea class="form-input form-textarea" id="aboutUs" placeholder="My fiancé John and I are getting married..." required></textarea>
                        <div class="form-error" id="aboutUsError">Please tell us about your wedding</div>
                    </div>

                    <div class="nav-arrows">
                        <button class="nav-arrow" onclick="prevSlide()">‹</button>
                        <button class="nav-arrow" onclick="nextSlide()">›</button>
                    </div>
                </div>
            </div>

            <!-- SLIDE 4: Engagement Date -->
            <div class="slide hidden" id="slide4">
                <div class="box-light-peach">
                    <h2 class="text-navy text-center mb-md">When did you get engaged?</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Engagement Date</label>
                        <input type="date" class="form-input" id="engagementDate" required>
                        <div class="form-error" id="engagementError">Please select your engagement date</div>
                    </div>

                    <div class="nav-arrows">
                        <button class="nav-arrow" onclick="prevSlide()">‹</button>
                        <button class="nav-arrow" onclick="nextSlide()">›</button>
                    </div>
                </div>
            </div>

            <!-- SLIDE 5: Planning Status -->
            <div class="slide hidden" id="slide5">
                <div class="box-ivory">
                    <h2 class="text-navy text-center mb-lg">Have you started planning anything yet?</h2>
                    
                    <button class="btn btn-primary btn-full btn-lg mb-md" onclick="selectPlanningStatus(false)">
                        Not Yet
                    </button>
                    
                    <button class="btn btn-secondary btn-full btn-lg" onclick="selectPlanningStatus(true)">
                        Yes, I've Started!
                    </button>

                    <div class="nav-arrows mt-lg">
                        <button class="nav-arrow" onclick="prevSlide()">‹</button>
                        <button class="nav-arrow" disabled>›</button>
                    </div>
                </div>
            </div>

            <!-- SLIDE 6: Planning Checklist (only if "Yes") -->
            <div class="slide hidden" id="slide6">
                <div class="box-light-blue">
                    <h2 class="text-white text-center mb-md">What have you completed?</h2>
                    
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="planning" value="wedding_date">
                            <span class="checkbox-label">Wedding Date</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="planning" value="venue">
                            <span class="checkbox-label">Venue</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="planning" value="attire">
                            <span class="checkbox-label">Attire</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="planning" value="food">
                            <span class="checkbox-label">Food</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="planning" value="music">
                            <span class="checkbox-label">Music</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="planning" value="guests">
                            <span class="checkbox-label">Guests</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="planning" value="wedding_party">
                            <span class="checkbox-label">Wedding Party</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="planning" value="wedding_parties">
                            <span class="checkbox-label">Wedding Parties (the fun kind!)</span>
                        </label>
                    </div>

                    <div class="nav-arrows mt-lg">
                        <button class="nav-arrow" onclick="prevSlide()">‹</button>
                        <button class="nav-arrow" onclick="showLoading()">›</button>
                    </div>
                </div>
            </div>

            <!-- SLIDE 7: Loading with Lazy Susan -->
            <div class="slide hidden" id="slide7NotYet">
                <div class="loading-screen">
                    <!-- Lazy Susan with Wedding Icons + Circuit Nodes -->
                    <div class="lazy-susan">
                        <div class="lazy-susan-icon"></div>
                        <div class="lazy-susan-icon"></div>
                        <div class="lazy-susan-icon"></div>
                        <div class="lazy-susan-icon"></div>
                        <div class="circuit-node"></div>
                        <div class="circuit-node"></div>
                        <div class="circuit-node"></div>
                        <div class="circuit-node"></div>
                    </div>
                    <p class="loading-message">
                        No worries, you're in the right place. Give me a second to generate your Wedding Profile
                    </p>
                </div>
            </div>

            <!-- SLIDE 8: Loading (Yes) -->
            <div class="slide hidden" id="slide7Yes">
                <div class="loading-screen">
                    <!-- Lazy Susan with Wedding Icons + Circuit Nodes -->
                    <div class="lazy-susan">
                        <div class="lazy-susan-icon"></div>
                        <div class="lazy-susan-icon"></div>
                        <div class="lazy-susan-icon"></div>
                        <div class="lazy-susan-icon"></div>
                        <div class="circuit-node"></div>
                        <div class="circuit-node"></div>
                        <div class="circuit-node"></div>
                        <div class="circuit-node"></div>
                    </div>
                    <p class="loading-message">
                        Great work already! Let me build your wedding profile so I can gather more details through the chat
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase client
        const supabase = window.supabase.createClient(
            'https://nluvnjydydotsrpluhey.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sdXZuanlkeWRvdHNycGx1aGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NjE5MjAsImV4cCI6MjA3NjMzNzkyMH0.p5S8vYtZeYqp24avigifhjEDRaKv8TxJTaTkeLoE5mY'
        );

        // Track current slide and collected data
        let currentSlide = 1;
        let onboardingData = {
            email: '',
            password: '',
            fullName: '',
            aboutUs: '',
            engagementDate: '',
            startedPlanning: false,
            planningCompleted: []
        };

        // Update progress dots
        function updateProgress() {
            const dots = document.querySelectorAll('.progress-dot');
            dots.forEach((dot, index) => {
                if (index < currentSlide) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        // Validate current slide
        function validateSlide() {
            if (currentSlide === 1) {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                if (!email || !email.includes('@')) {
                    document.getElementById('emailError').style.display = 'block';
                    return false;
                }
                if (!password || password.length < 6) {
                    document.getElementById('passwordError').style.display = 'block';
                    return false;
                }
                
                onboardingData.email = email;
                onboardingData.password = password;
                return true;
            }
            
            if (currentSlide === 2) {
                const fullName = document.getElementById('fullName').value;
                if (!fullName) {
                    document.getElementById('nameError').style.display = 'block';
                    return false;
                }
                onboardingData.fullName = fullName;
                return true;
            }
            
            if (currentSlide === 3) {
                const aboutUs = document.getElementById('aboutUs').value;
                if (!aboutUs || aboutUs.length < 10) {
                    document.getElementById('aboutUsError').style.display = 'block';
                    return false;
                }
                onboardingData.aboutUs = aboutUs;
                return true;
            }
            
            if (currentSlide === 4) {
                const engagementDate = document.getElementById('engagementDate').value;
                if (!engagementDate) {
                    document.getElementById('engagementError').style.display = 'block';
                    return false;
                }
                onboardingData.engagementDate = engagementDate;
                return true;
            }
            
            return true;
        }

        // Show next slide
        function nextSlide() {
            if (!validateSlide()) return;
            
            // Hide current slide
            document.getElementById(`slide${currentSlide}`).classList.add('hidden');
            
            // Show next slide
            currentSlide++;
            const nextElement = document.getElementById(`slide${currentSlide}`);
            nextElement.classList.remove('hidden');
            
            const box = nextElement.querySelector('.box-ivory, .box-light-blue, .box-lavender, .box-light-peach');
            if (box) box.classList.add('slide-in-right');
            
            updateProgress();
            
            // Create account on slide 1 completion
            if (currentSlide === 2) {
                createAccount();
            }
        }

        // Show previous slide
        function prevSlide() {
            document.getElementById(`slide${currentSlide}`).classList.add('hidden');
            currentSlide--;
            const prevElement = document.getElementById(`slide${currentSlide}`);
            prevElement.classList.remove('hidden');
            
            const box = prevElement.querySelector('.box-ivory, .box-light-blue, .box-lavender, .box-light-peach');
            if (box) box.classList.add('slide-in-left');
            
            updateProgress();
        }

        // Handle planning status selection
        function selectPlanningStatus(started) {
            onboardingData.startedPlanning = started;
            
            document.getElementById('slide5').classList.add('hidden');
            
            if (started) {
                currentSlide = 6;
                document.getElementById('slide6').classList.remove('hidden');
                document.getElementById('slide6').querySelector('.box-light-blue').classList.add('slide-in-right');
            } else {
                currentSlide = 7;
                document.getElementById('slide7NotYet').classList.remove('hidden');
                setTimeout(createWedding, 3000);
            }
            
            updateProgress();
        }

        // Show loading screen
        function showLoading() {
            // Collect checked planning items
            const checkboxes = document.querySelectorAll('input[name="planning"]:checked');
            onboardingData.planningCompleted = Array.from(checkboxes).map(cb => cb.value);
            
            document.getElementById('slide6').classList.add('hidden');
            currentSlide = 7;
            document.getElementById('slide7Yes').classList.remove('hidden');
            updateProgress();
            
            setTimeout(createWedding, 3000);
        }

        // Create Supabase account
        async function createAccount() {
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: onboardingData.email,
                    password: onboardingData.password,
                    options: {
                        data: {
                            full_name: onboardingData.fullName
                        }
                    }
                });
                
                if (error) throw error;
                
                console.log('Account created:', data);
            } catch (error) {
                console.error('Error creating account:', error);
                alert('Error creating account. Please try again.');
            }
        }

        // Create wedding profile
        async function createWedding() {
            try {
                // Get current authenticated user
                const { data: { user }, error: authError } = await supabase.auth.getUser();

                // Handle case where user is not authenticated
                if (authError || !user) {
                    console.error('Authentication error:', authError);
                    alert('You must be logged in to create a wedding profile. Please refresh and try again.');
                    window.location.href = 'login-v2.html';
                    return;
                }

                // Add userId to the request data
                const requestData = {
                    ...onboardingData,
                    userId: user.id
                };

                const response = await fetch('/api/create-wedding', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (data.success) {
                    // Redirect to subscription page
                    window.location.href = 'subscribe-v2.html?wedding_id=' + data.wedding_id;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error creating wedding:', error);
                alert('Error creating wedding profile. Please try again.');
            }
        }

        // Clear error messages on input
        document.querySelectorAll('.form-input').forEach(input => {
            input.addEventListener('input', () => {
                const errorElement = input.parentElement.querySelector('.form-error');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
