<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bride Buddy - Invite Collaborators</title>
    <link rel="stylesheet" href="styles-v2.css">
</head>
<body class="bg-bridal">
    <div class="screen">
        <div class="container">
            <!-- Header -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                <button class="nav-arrow" onclick="goBack()" style="background: rgba(212, 175, 55, 0.2); border-color: var(--gold); color: var(--navy);">
                    ‚Üê
                </button>
                <h2 style="color: var(--navy); font-family: var(--font-heading); margin: 0;">Invite Collaborators</h2>
                <div style="width: 48px;"></div>
            </div>

            <!-- Invite Form -->
            <div class="box-ivory fade-in">
                <h3 class="text-navy mb-md">Who would you like to invite?</h3>
                
                <form id="inviteForm" onsubmit="sendInvite(event)">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" id="inviteeName" placeholder="Jane Doe" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="inviteeEmail" placeholder="jane@example.com" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select class="form-input" id="inviteeRole" required onchange="toggleEditPermission()">
                            <option value="">Select a role...</option>
                            <option value="partner">Partner (Full Edit Access)</option>
                            <option value="co_planner">Co-planner (View + Request Changes)</option>
                            <option value="bestie">Bestie (MOH/Best Man)</option>
                        </select>
                    </div>

                    <!-- Edit permission for co-planners -->
                    <div class="form-group hidden" id="editPermissionGroup">
                        <label class="checkbox-item" style="background: rgba(156, 118, 198, 0.1);">
                            <input type="checkbox" id="canEdit">
                            <span class="checkbox-label" style="color: var(--navy);">Allow edit requests (requires approval)</span>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full btn-lg" id="inviteBtn">
                        Send Invite
                    </button>
                </form>
            </div>

            <!-- Pending Invites -->
            <div class="box-light-blue mt-lg fade-in" style="animation-delay: 0.1s;">
                <h3 class="text-white mb-md">Pending Invites</h3>
                <div id="pendingInvites">
                    <p class="text-white" style="opacity: 0.7; text-align: center;">No pending invites</p>
                </div>
            </div>

            <!-- Current Members -->
            <div class="box-lavender mt-lg fade-in" style="animation-delay: 0.2s;">
                <h3 class="text-navy mb-md">Current Members</h3>
                <div id="currentMembers">
                    <p class="text-navy" style="opacity: 0.7; text-align: center;">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabase = window.supabase.createClient(
            'https://nluvnjydydotsrpluhey.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sdXZuanlkeWRvdHNycGx1aGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NjE5MjAsImV4cCI6MjA3NjMzNzkyMH0.p5S8vYtZeYqp24avigifhjEDRaKv8TxJTaTkeLoE5mY'
        );

        const urlParams = new URLSearchParams(window.location.search);
        const weddingId = urlParams.get('wedding_id');

        function goBack() {
            window.location.href = `dashboard-v2.html?wedding_id=${weddingId}`;
        }

        function toggleEditPermission() {
            const role = document.getElementById('inviteeRole').value;
            const editGroup = document.getElementById('editPermissionGroup');
            
            if (role === 'co_planner') {
                editGroup.classList.remove('hidden');
            } else {
                editGroup.classList.add('hidden');
            }
        }

        async function sendInvite(event) {
            event.preventDefault();
            
            const name = document.getElementById('inviteeName').value;
            const email = document.getElementById('inviteeEmail').value;
            const role = document.getElementById('inviteeRole').value;
            const canEdit = role === 'co_planner' ? document.getElementById('canEdit').checked : false;
            
            const btn = document.getElementById('inviteBtn');
            btn.disabled = true;
            btn.textContent = 'Sending...';
            
            try {
                const response = await fetch('/api/create-invite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        wedding_id: weddingId,
                        invitee_name: name,
                        invitee_email: email,
                        role: role,
                        can_edit: canEdit
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Invite sent to ${name}! They'll receive an email with a link to join.`);
                    document.getElementById('inviteForm').reset();
                    loadPendingInvites();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error sending invite:', error);
                alert('Error sending invite. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Invite';
            }
        }

        async function loadPendingInvites() {
            try {
                const { data: invites, error } = await supabase
                    .from('invite_codes')
                    .select('*')
                    .eq('wedding_id', weddingId)
                    .eq('is_used', false)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const container = document.getElementById('pendingInvites');
                
                if (!invites || invites.length === 0) {
                    container.innerHTML = '<p class="text-white" style="opacity: 0.7; text-align: center;">No pending invites</p>';
                    return;
                }
                
                container.innerHTML = invites.map(invite => `
                    <div style="background: rgba(255, 255, 255, 0.2); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="color: white; font-weight: 600;">${invite.invitee_name}</div>
                        <div style="color: white; opacity: 0.8; font-size: 0.875rem;">${invite.invitee_email}</div>
                        <div style="color: white; opacity: 0.7; font-size: 0.875rem; margin-top: 4px;">Role: ${invite.role}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading invites:', error);
            }
        }

        async function loadCurrentMembers() {
            try {
                const { data: members, error } = await supabase
                    .from('wedding_members')
                    .select(`
                        *,
                        profiles (full_name, email)
                    `)
                    .eq('wedding_id', weddingId)
                    .eq('status', 'active');
                
                if (error) throw error;
                
                const container = document.getElementById('currentMembers');
                
                if (!members || members.length === 0) {
                    container.innerHTML = '<p class="text-navy" style="opacity: 0.7; text-align: center;">No members yet</p>';
                    return;
                }
                
                container.innerHTML = members.map(member => `
                    <div style="background: rgba(60, 0, 157, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="color: var(--navy); font-weight: 600;">${member.profiles.full_name || 'Unknown'}</div>
                        <div style="color: var(--navy); opacity: 0.8; font-size: 0.875rem;">${member.profiles.email}</div>
                        <div style="color: var(--navy); opacity: 0.7; font-size: 0.875rem; margin-top: 4px;">
                            Role: ${member.role} ${member.can_edit ? '(Can edit)' : '(View only)'}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading members:', error);
            }
        }

        // Initialize
        loadPendingInvites();
        loadCurrentMembers();
    </script>
</body>
</html>
