<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Wedding - Bride Buddy</title>
    <link rel="stylesheet" href="/css/styles-v2.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Gradient Background -->
    <div class="bg-gradient"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div style="text-align: center;">
            <div class="lazy-susan">
                <div class="lazy-susan-item">ü•Ç</div>
                <div class="lazy-susan-item">üíç</div>
                <div class="lazy-susan-item">üéÇ</div>
                <div class="lazy-susan-item">üíï</div>
                <div class="lazy-susan-item" style="top: 25%; left: 25%;">‚ö°</div>
            </div>
            <div class="loading-text">Joining wedding profile...</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="onboarding-container">
            <div class="box box-ivory" style="max-width: 600px; margin: 0 auto;">
                <div id="inviteContent">
                    <h1 class="text-center">You're Invited! üíï</h1>
                    <p class="text-center" style="font-size: 1.2rem; margin: 20px 0; color: #666;">
                        You've been invited to be a co-planner for a wedding!
                    </p>

                    <div class="box box-lavender" style="margin: 30px 0;">
                        <h3>What you'll get:</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin: 10px 0;">‚úì Full access to the wedding profile</li>
                            <li style="margin: 10px 0;">‚úì Chat with Bride Buddy AI</li>
                            <li style="margin: 10px 0;">‚úì Collaborate in real-time</li>
                            <li style="margin: 10px 0;">‚úì Manage vendors & budget together</li>
                        </ul>
                    </div>

                    <div id="authForm">
                        <h3>Create your account to join:</h3>
                        <form onsubmit="handleJoin(event)">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="email" placeholder="your@email.com" required>
                            </div>
                            <div class="form-group">
                                <label>Password</label>
                                <input type="password" id="password" placeholder="Choose a secure password" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                                Join Wedding Profile
                            </button>
                        </form>

                        <div class="text-center" style="margin-top: 20px;">
                            <p style="color: #666;">
                                Already have an account? <a href="#" onclick="showSignIn(); return false;" style="color: var(--purple); text-decoration: underline;">Sign in instead</a>
                            </p>
                        </div>
                    </div>

                    <div id="signInForm" class="hidden">
                        <h3>Sign in to join:</h3>
                        <form onsubmit="handleSignIn(event)">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="signInEmail" placeholder="your@email.com" required>
                            </div>
                            <div class="form-group">
                                <label>Password</label>
                                <input type="password" id="signInPassword" placeholder="Your password" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                                Sign In & Join
                            </button>
                        </form>

                        <div class="text-center" style="margin-top: 20px;">
                            <p style="color: #666;">
                                Need to create an account? <a href="#" onclick="showSignUp(); return false;" style="color: var(--purple); text-decoration: underline;">Sign up instead</a>
                            </p>
                        </div>
                    </div>
                </div>

                <div id="errorMessage" class="hidden" style="background: #ffebee; padding: 20px; border-radius: 12px; margin-top: 20px;">
                    <p style="color: #c62828; margin: 0;" id="errorText"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const supabase = window.supabase.createClient(
            'https://nluvnjydydotsrpluhey.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sdXZuanlkeWRvdHNycGx1aGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NjE5MjAsImV4cCI6MjA3NjMzNzkyMH0.p5S8vYtZeYqp24avigifhjEDRaKv8TxJTaTkeLoE5mY'
        );

        // Get invite code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const inviteCode = urlParams.get('code');

        if (!inviteCode) {
            showError('Invalid invite link. Please ask for a new invite.');
        }

        function showSignIn() {
            document.getElementById('authForm').classList.add('hidden');
            document.getElementById('signInForm').classList.remove('hidden');
        }

        function showSignUp() {
            document.getElementById('signInForm').classList.add('hidden');
            document.getElementById('authForm').classList.remove('hidden');
        }

        async function handleJoin(event) {
            event.preventDefault();
            document.getElementById('loadingOverlay').classList.remove('hidden');

            try {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                // Sign up
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password
                });

                if (authError) throw authError;

                // Join wedding
                await joinWedding(authData.session.access_token);

            } catch (error) {
                document.getElementById('loadingOverlay').classList.add('hidden');
                showError(error.message);
            }
        }

        async function handleSignIn(event) {
            event.preventDefault();
            document.getElementById('loadingOverlay').classList.remove('hidden');

            try {
                const email = document.getElementById('signInEmail').value;
                const password = document.getElementById('signInPassword').value;

                // Sign in
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                // Join wedding
                await joinWedding(data.session.access_token);

            } catch (error) {
                document.getElementById('loadingOverlay').classList.add('hidden');
                showError(error.message);
            }
        }

        async function joinWedding(accessToken) {
            try {
                const response = await fetch('/api/join-wedding', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userToken: accessToken,
                        inviteCode: inviteCode
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to join wedding');
                }

                // Success! Redirect to dashboard
                setTimeout(() => {
                    window.location.href = '/dashboard-v2.html';
                }, 2000);

            } catch (error) {
                throw error;
            }
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
        }
    </script>
</body>
</html>
