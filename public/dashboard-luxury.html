<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Your Bride Buddy wedding planning dashboard">
    <title>Dashboard - Bride Buddy</title>

    <!-- Preconnect to font providers -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/styles-luxury.css">
    <link rel="stylesheet" href="/css/components-luxury.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-to-main">Skip to main content</a>

    <div class="bg-sunset">

        <!-- Top Navbar -->
        <nav class="navbar">
            <div class="navbar-container">
                <!-- Logo -->
                <a href="index-luxury.html" style="text-decoration: none;">
                    <h1 class="logo-led" style="font-family: var(--font-heading); font-size: var(--text-xl); margin: 0; line-height: 1;">
                        <span style="font-style: italic; font-weight: 400;">Bride</span>
                        <span style="font-weight: 700;">BUDDY</span>
                    </h1>
                </a>

                <!-- Wedding Name -->
                <div class="navbar-center">
                    <div class="navbar-wedding-name" id="weddingName">Loading...</div>
                    <span id="trialBadge" class="badge badge-gold" style="margin-left: var(--space-2);"></span>
                </div>

                <!-- User Menu -->
                <div class="navbar-menu">
                    <button class="navbar-user-button" id="userMenuBtn" aria-label="User menu" aria-expanded="false">
                        <div class="navbar-avatar" id="userAvatar">?</div>
                        <span id="userName">User</span>
                        <svg width="16" height="16" fill="currentColor" style="margin-left: var(--space-1);">
                            <path d="M4.5 6l3.5 3.5L11.5 6z"/>
                        </svg>
                    </button>

                    <div class="dropdown-menu" id="userDropdown" role="menu">
                        <a href="profile-luxury.html" class="dropdown-item" role="menuitem" id="profileLink">
                            <span>üë§</span> Profile
                        </a>
                        <a href="settings-luxury.html" class="dropdown-item" role="menuitem" id="settingsLink">
                            <span>‚öôÔ∏è</span> Settings
                        </a>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item" id="logoutBtn" role="menuitem">
                            <span>üö™</span> Log Out
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <ul style="list-style: none; padding: 0; margin: 0;">
                    <li class="sidebar-item">
                        <a href="dashboard-luxury.html" class="sidebar-link is-active">
                            <span class="sidebar-icon">üè†</span>
                            Dashboard
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="chat-luxury.html" class="sidebar-link">
                            <span class="sidebar-icon">üí¨</span>
                            AI Chat
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="team-luxury.html" class="sidebar-link" id="teamLink">
                            <span class="sidebar-icon">üë•</span>
                            Team
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="invite-luxury.html" class="sidebar-link">
                            <span class="sidebar-icon">‚úâÔ∏è</span>
                            Invites
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="bestie-luxury.html" class="sidebar-link">
                            <span class="sidebar-icon">ü§´</span>
                            Bestie Mode
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="settings-luxury.html" class="sidebar-link" id="settingsSidebarLink">
                            <span class="sidebar-icon">‚öôÔ∏è</span>
                            Settings
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="main-content" style="margin-left: 260px; padding: var(--space-6); min-height: calc(100vh - 72px);">

            <!-- Welcome Message -->
            <div style="margin-bottom: var(--space-8);">
                <h1 style="font-family: var(--font-heading); font-size: var(--text-4xl); color: var(--color-navy); margin-bottom: var(--space-2);">
                    Welcome back, <span id="welcomeName">there</span>!
                </h1>
                <p style="font-size: var(--text-lg); color: var(--color-burgundy);">
                    Here's what's happening with your wedding planning
                </p>
            </div>

            <!-- MVP Dashboard: 4 Core Elements -->
            <div class="grid grid-cols-2 gap-6" style="margin-bottom: var(--space-8);">
                <!-- 1. Wedding Countdown -->
                <div class="card">
                    <p style="font-size: var(--text-sm); color: var(--color-burgundy); margin-bottom: var(--space-2); font-weight: var(--font-semibold);">
                        Wedding Countdown
                    </p>
                    <h2 id="daysUntil" style="font-size: var(--text-5xl); color: var(--color-gold); margin: 0; font-family: var(--font-heading);">
                        --
                    </h2>
                    <p style="font-size: var(--text-xs); color: var(--color-burgundy); margin-top: var(--space-2); opacity: 0.8;" id="weddingDate">
                        Set your date
                    </p>
                </div>

                <!-- 2. Financial Tracker -->
                <div class="card">
                    <p style="font-size: var(--text-sm); color: var(--color-burgundy); margin-bottom: var(--space-2); font-weight: var(--font-semibold);">
                        Budget Summary
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-3); margin-top: var(--space-3);">
                        <div>
                            <p style="font-size: var(--text-xs); color: var(--color-burgundy); opacity: 0.7; margin: 0;">Total Budget</p>
                            <p id="totalBudget" style="font-size: var(--text-xl); color: var(--color-navy); font-weight: var(--font-semibold); margin: 0;">$0</p>
                        </div>
                        <div>
                            <p style="font-size: var(--text-xs); color: var(--color-burgundy); opacity: 0.7; margin: 0;">Spent</p>
                            <p id="totalSpent" style="font-size: var(--text-xl); color: var(--color-gold); font-weight: var(--font-semibold); margin: 0;">$0</p>
                        </div>
                        <div>
                            <p style="font-size: var(--text-xs); color: var(--color-burgundy); opacity: 0.7; margin: 0;">Remaining</p>
                            <p id="totalRemaining" style="font-size: var(--text-xl); color: var(--color-navy); font-weight: var(--font-semibold); margin: 0;">$0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Confirmed Vendors -->
            <div class="card" style="margin-bottom: var(--space-8);">
                <h3 style="font-family: var(--font-heading); font-size: var(--text-2xl); color: var(--color-navy); margin-bottom: var(--space-4);">
                    Confirmed Vendors
                </h3>
                <div id="vendorList" style="display: flex; flex-direction: column; gap: var(--space-3);">
                    <!-- Dynamic vendor list -->
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text"></div>
                </div>
                <!-- Empty State -->
                <div class="empty-state" id="emptyVendors" style="display: none; padding: var(--space-6) var(--space-4);">
                    <div class="empty-state-icon">üé™</div>
                    <h4 class="empty-state-title">No vendors booked yet</h4>
                    <p class="empty-state-description">
                        Start booking your vendors by chatting with your AI assistant.
                    </p>
                </div>
            </div>

            <!-- 4. Next To-Do -->
            <div class="card">
                <h3 style="font-family: var(--font-heading); font-size: var(--text-2xl); color: var(--color-navy); margin-bottom: var(--space-4);">
                    Next To-Do
                </h3>
                <div id="taskList" style="display: flex; flex-direction: column; gap: var(--space-3);">
                    <!-- Dynamic task list -->
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text"></div>
                </div>
                <!-- Empty State -->
                <div class="empty-state" id="emptyTasks" style="display: none; padding: var(--space-6) var(--space-4);">
                    <div class="empty-state-icon">‚úÖ</div>
                    <h4 class="empty-state-title">No tasks yet</h4>
                    <p class="empty-state-description">
                        Tasks will appear here as you plan with your AI assistant.
                    </p>
                </div>
            </div>
        </main>

        <!-- Mobile Bottom Nav -->
        <nav class="bottom-nav">
            <a href="dashboard-luxury.html" class="bottom-nav-item is-active">
                <span class="bottom-nav-icon">üè†</span>
                Home
            </a>
            <a href="chat-luxury.html" class="bottom-nav-item">
                <span class="bottom-nav-icon">üí¨</span>
                Chat
            </a>
            <a href="team-luxury.html" class="bottom-nav-item" id="teamBottomLink">
                <span class="bottom-nav-icon">üë•</span>
                Team
            </a>
            <a href="settings-luxury.html" class="bottom-nav-item" id="settingsBottomLink">
                <span class="bottom-nav-icon">‚öôÔ∏è</span>
                Settings
            </a>
        </nav>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import {
            initSupabase,
            loadWeddingData,
            navigateTo,
            logout as sharedLogout
        } from '/js/shared.js';

        let supabase = null;
        let weddingId = null;
        let wedding = null;

        // Initialize Supabase with error handling
        try {
            supabase = initSupabase();
            console.log('‚úÖ Supabase client initialized successfully');
        } catch (error) {
            console.error('‚ùå Failed to initialize Supabase:', error);
            showToast('error', 'Connection Error', 'Failed to connect to database. Please refresh the page.');
        }

        // Retry utility with exponential backoff
        async function retryWithBackoff(fn, maxRetries = 3, initialDelay = 1000) {
            let lastError;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    return await fn();
                } catch (error) {
                    lastError = error;
                    if (attempt < maxRetries - 1) {
                        const delay = initialDelay * Math.pow(2, attempt);
                        console.log(`Retry attempt ${attempt + 1} after ${delay}ms`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            throw lastError;
        }

        // Show Toast Notification
        function showToast(type, title, message, duration = 5000) {
            const container = document.getElementById('toastContainer');

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <p class="toast-message">${message}</p>
                </div>
                <button class="toast-close">√ó</button>
            `;

            container.appendChild(toast);

            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.remove();
            });

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Show error state with retry button
        function showErrorState(containerId, retryFn, errorMessage = 'Failed to load data') {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="error-state" style="padding: var(--space-6) var(--space-4); text-align: center;">
                    <div style="font-size: var(--text-4xl); margin-bottom: var(--space-3);">‚ö†Ô∏è</div>
                    <h4 style="font-family: var(--font-heading); font-size: var(--text-lg); color: var(--color-navy); margin-bottom: var(--space-2);">
                        ${errorMessage}
                    </h4>
                    <button class="btn btn-secondary btn-sm" onclick="this.disabled=true; this.textContent='Retrying...'; ${retryFn}">
                        üîÑ Retry
                    </button>
                </div>
            `;
            container.style.display = 'block';
        }

        // Calculate days until wedding
        function calculateDaysUntil(dateString) {
            if (!dateString) return null;
            const weddingDate = new Date(dateString);
            const today = new Date();
            const diffTime = weddingDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // Update Trial Badge
        function updateTrialBadge(wedding) {
            const badge = document.getElementById('trialBadge');
            if (!wedding) return;

            if (wedding.subscription_status === 'trialing' && wedding.trial_end_date) {
                const trialEnds = new Date(wedding.trial_end_date);
                const today = new Date();
                const daysLeft = Math.ceil((trialEnds - today) / (1000 * 60 * 60 * 24));

                badge.textContent = `${daysLeft} Days Left`;
                badge.className = 'badge badge-gold';
                badge.style.display = 'inline-flex';
            } else if (wedding.is_vip) {
                badge.textContent = 'VIP';
                badge.className = 'badge badge-gold';
                badge.style.display = 'inline-flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // Load and display wedding data
        async function initializeDashboard() {
            try {
                const result = await loadWeddingData();
                weddingId = result.weddingId;
                wedding = result.wedding;
                const user = result.user;
                const member = result.member;

                // Redirect besties to their dedicated interface
                if (member && member.role === 'bestie') {
                    console.log('Bestie user detected, redirecting to bestie dashboard');
                    window.location.href = `bestie-luxury.html?wedding_id=${weddingId}`;
                    return; // Stop execution while redirecting
                }

                // Update UI with user info
                const userName = user.user_metadata?.full_name || user.email?.split('@')[0] || 'User';
                document.getElementById('userName').textContent = userName;
                document.getElementById('welcomeName').textContent = userName.split(' ')[0];

                // Update avatar
                const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                document.getElementById('userAvatar').textContent = initials;

                // Update wedding name
                const weddingName = wedding.wedding_name || `${wedding.partner1_name || 'Partner 1'} & ${wedding.partner2_name || 'Partner 2'}`;
                document.getElementById('weddingName').textContent = weddingName;

                // Update navigation links with wedding_id
                const navLinks = ['profileLink', 'settingsLink', 'teamLink', 'settingsSidebarLink', 'teamBottomLink', 'settingsBottomLink'];
                navLinks.forEach(linkId => {
                    const link = document.getElementById(linkId);
                    if (link && weddingId) {
                        const url = new URL(link.href);
                        url.searchParams.set('wedding_id', weddingId);
                        link.href = url.toString();
                    }
                });

                // Update trial badge
                updateTrialBadge(wedding);

                // Calculate days until wedding
                if (wedding.wedding_date) {
                    const days = calculateDaysUntil(wedding.wedding_date);
                    document.getElementById('daysUntil').textContent = days > 0 ? days : '0';
                    const dateStr = new Date(wedding.wedding_date).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    document.getElementById('weddingDate').textContent = dateStr;
                } else {
                    document.getElementById('daysUntil').textContent = '--';
                    document.getElementById('weddingDate').textContent = 'Set your date';
                }

                // Load MVP dashboard sections in parallel for better performance
                await Promise.all([
                    loadFinancialTracker(),
                    loadConfirmedVendors(),
                    loadNextToDo()
                ]);

            } catch (error) {
                console.error('Dashboard initialization error:', error);
                showToast('error', 'Error', 'Failed to load dashboard data');
            }
        }

        // Load Financial Tracker (Budget Summary)
        async function loadFinancialTracker() {
            try {
                await retryWithBackoff(async () => {
                    const { data: budgetItems, error } = await supabase
                        .from('budget_tracker')
                        .select('budgeted_amount, spent_amount')
                        .eq('wedding_id', weddingId);

                    if (error) throw error;

                    // Calculate totals
                    const totalBudget = budgetItems?.reduce((sum, item) => sum + (parseFloat(item.budgeted_amount) || 0), 0) || 0;
                    const totalSpent = budgetItems?.reduce((sum, item) => sum + (parseFloat(item.spent_amount) || 0), 0) || 0;
                    const totalRemaining = totalBudget - totalSpent;

                    // Format and display
                    document.getElementById('totalBudget').textContent = `$${totalBudget.toLocaleString()}`;
                    document.getElementById('totalSpent').textContent = `$${totalSpent.toLocaleString()}`;
                    document.getElementById('totalRemaining').textContent = `$${totalRemaining.toLocaleString()}`;
                });
            } catch (error) {
                console.error('Error loading financial tracker:', error);
                // Show error state instead of zeros
                document.getElementById('totalBudget').textContent = '--';
                document.getElementById('totalBudget').style.color = 'var(--color-burgundy)';
                document.getElementById('totalSpent').textContent = '--';
                document.getElementById('totalSpent').style.color = 'var(--color-burgundy)';
                document.getElementById('totalRemaining').textContent = '--';
                document.getElementById('totalRemaining').style.color = 'var(--color-burgundy)';
                showToast('error', 'Budget Load Failed', 'Could not load budget data. Click refresh to retry.');
            }
        }

        // Load Confirmed Vendors
        async function loadConfirmedVendors() {
            const vendorList = document.getElementById('vendorList');
            const emptyState = document.getElementById('emptyVendors');

            try {
                await retryWithBackoff(async () => {
                    // Query vendors with booked status
                    const { data: vendors, error } = await supabase
                        .from('vendor_tracker')
                        .select('vendor_type, vendor_name, deposit_paid')
                        .eq('wedding_id', weddingId)
                        .in('status', ['booked', 'contract_signed', 'deposit_paid', 'fully_paid'])
                        .order('vendor_type');

                    if (error) throw error;

                    vendorList.innerHTML = '';

                    if (!vendors || vendors.length === 0) {
                        vendorList.style.display = 'none';
                        emptyState.style.display = 'block';
                        return;
                    }

                    vendorList.style.display = 'flex';
                    emptyState.style.display = 'none';

                    vendors.forEach(vendor => {
                        const vendorItem = document.createElement('div');
                        vendorItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); background: var(--color-cream); border-radius: var(--radius-md);';

                        const vendorTypeFormatted = vendor.vendor_type
                            .replace(/_/g, ' ')
                            .split(' ')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                            .join(' ');

                        vendorItem.innerHTML = `
                            <div>
                                <p style="margin: 0; font-size: var(--text-sm); color: var(--color-navy); font-weight: var(--font-semibold);">
                                    ${vendorTypeFormatted}
                                </p>
                                <p style="margin: 0; font-size: var(--text-xs); color: var(--color-burgundy); opacity: 0.7; margin-top: 2px;">
                                    ${vendor.vendor_name || 'Name not set'}
                                </p>
                            </div>
                            <div style="color: ${vendor.deposit_paid ? 'var(--color-gold)' : 'var(--color-burgundy)'}; font-size: var(--text-lg);">
                                ${vendor.deposit_paid ? '‚úì' : '‚óã'}
                            </div>
                        `;
                        vendorList.appendChild(vendorItem);
                    });
                });
            } catch (error) {
                console.error('Error loading confirmed vendors:', error);
                // Show error state with retry button
                vendorList.innerHTML = '';
                vendorList.style.display = 'block';
                emptyState.style.display = 'none';
                showErrorState('vendorList', 'loadConfirmedVendors()', 'Failed to load vendors');
            }
        }

        // Load Next To-Do (Top 3 Upcoming Tasks)
        async function loadNextToDo() {
            const taskList = document.getElementById('taskList');
            const emptyState = document.getElementById('emptyTasks');

            try {
                await retryWithBackoff(async () => {
                    // Query tasks that are not completed, ordered by due date
                    const { data: tasks, error } = await supabase
                        .from('wedding_tasks')
                        .select('task_name, due_date')
                        .eq('wedding_id', weddingId)
                        .neq('status', 'completed')
                        .order('due_date', { ascending: true, nullsLast: true })
                        .limit(3);

                    if (error) throw error;

                    taskList.innerHTML = '';

                    if (!tasks || tasks.length === 0) {
                        taskList.style.display = 'none';
                        emptyState.style.display = 'block';
                        return;
                    }

                    taskList.style.display = 'flex';
                    emptyState.style.display = 'none';

                    tasks.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); background: var(--color-cream); border-radius: var(--radius-md);';

                        let dueDateFormatted = 'No deadline';

                        if (task.due_date) {
                            const dueDate = new Date(task.due_date);
                            dueDateFormatted = dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        }

                        taskItem.innerHTML = `
                            <p style="margin: 0; font-size: var(--text-sm); color: var(--color-navy); font-weight: var(--font-semibold);">
                                ${task.task_name}
                            </p>
                            <p style="margin: 0; font-size: var(--text-xs); color: var(--color-burgundy); opacity: 0.7;">
                                ${dueDateFormatted}
                            </p>
                        `;
                        taskList.appendChild(taskItem);
                    });
                });
            } catch (error) {
                console.error('Error loading next to-do:', error);
                // Show error state with retry button
                taskList.innerHTML = '';
                taskList.style.display = 'block';
                emptyState.style.display = 'none';
                showErrorState('taskList', 'loadNextToDo()', 'Failed to load tasks');
            }
        }

        // Dropdown toggle
        const userMenuBtn = document.getElementById('userMenuBtn');
        const userDropdown = document.getElementById('userDropdown');

        userMenuBtn.addEventListener('click', () => {
            const isActive = userDropdown.classList.toggle('is-active');
            userMenuBtn.setAttribute('aria-expanded', isActive);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                userDropdown.classList.remove('is-active');
                userMenuBtn.setAttribute('aria-expanded', 'false');
            }
        });

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await sharedLogout();
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Initialize dashboard when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDashboard);
        } else {
            // DOM already loaded
            initializeDashboard();
        }

    </script>

    <!-- Responsive Styles -->
    <style>
        /* Hide sidebar on mobile */
        @media (max-width: 1023px) {
            main {
                margin-left: 0 !important;
                padding-bottom: 80px !important;
            }
        }

        /* Responsive grid */
        @media (max-width: 768px) {
            .grid-cols-2 {
                grid-template-columns: 1fr !important;
            }
        }

        /* Smooth animations */
        .card {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</body>
</html>
